<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>med-EVE (Evidence Vector Engine) Demo - Medical AI Reasoning</title>
    <script src="https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            color: #333;
            overflow: hidden;
        }

        /* Header */
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        #header h1 {
            font-size: 20px;
            font-weight: 600;
            margin-right: auto;
        }

        #demo-mode-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        #demo-mode-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        #case-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #case-selector select, #case-selector button {
            padding: 6px 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            border-radius: 4px;
            font-size: 14px;
        }

        #case-selector select option {
            background: #667eea;
            color: white;
        }

        /* Model Status Indicator */
        #model-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            background: rgba(255,255,255,0.15);
            border: 1px solid rgba(255,255,255,0.2);
        }

        #model-status.active {
            background: rgba(76, 175, 80, 0.3);
            border-color: rgba(76, 175, 80, 0.5);
        }

        #model-status.lite {
            background: rgba(158, 158, 158, 0.2);
            border-color: rgba(158, 158, 158, 0.3);
        }

        #model-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }

        #model-status.lite .status-dot {
            background: #9E9E9E;
        }

        #model-status.loading {
            background: rgba(255, 193, 7, 0.25);
            border-color: rgba(255, 193, 7, 0.5);
        }

        #model-status.loading .status-dot {
            background: #FFC107;
            animation: model-status-pulse 1.2s ease-in-out infinite;
        }

        @keyframes model-status-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* Timeline */
        #timeline {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            overflow-x: auto;
            min-height: 70px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .step-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            border-radius: 25px;
            background: #e8eaf6;
            color: #5c6bc0;
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .step-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        .step-chip.active::before {
            left: 100%;
        }

        .step-chip.active {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
            transform: scale(1.05);
        }

        .step-chip.completed {
            background: linear-gradient(135deg, #81C784 0%, #66bb6a 100%);
            color: white;
        }

        .step-duration {
            font-size: 11px;
            opacity: 0.9;
            margin-left: 4px;
            font-weight: 400;
        }

        /* Playback controls */
        #playback-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: auto;
            padding-left: 20px;
            border-left: 2px solid #e0e0e0;
        }

        #playback-controls button {
            padding: 8px 14px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }

        #playback-controls button:hover {
            background: #f5f5f5;
            border-color: #667eea;
            transform: translateY(-1px);
        }

        #playback-controls button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        /* Main layout */
        #main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left panel */
        #left {
            width: 320px;
            background: white;
            border-right: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #left h3 {
            padding: 16px;
            border-bottom: 2px solid #e0e0e0;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
        }

        #abnormal-labs {
            padding: 12px;
        }

        .lab-item {
            padding: 14px;
            margin-bottom: 10px;
            border-radius: 10px;
            border-left: 5px solid #ddd;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .lab-item.HIGH {
            border-left-color: #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }

        .lab-item.LOW {
            border-left-color: #2196F3;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }

        .lab-item.pulse {
            animation: pulseGlow 1.5s ease-in-out infinite;
            box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            transform: scale(1.02);
        }

        @keyframes pulseGlow {
            0% { 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
                transform: scale(1.02);
            }
            50% {
                transform: scale(1.05);
            }
            70% { 
                box-shadow: 0 0 0 15px rgba(76, 175, 80, 0);
                transform: scale(1.02);
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
                transform: scale(1.02);
            }
        }

        .lab-item .marker-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 6px;
            color: #212529;
        }

        .lab-item .lab-value {
            font-size: 13px;
            color: #6c757d;
        }

        /* Center - Graph */
        #center {
            flex: 1;
            position: relative;
            background: linear-gradient(135deg, #fafafa 0%, #f5f5f5 100%);
            overflow: hidden;
        }

        #cy {
            width: 100%;
            height: 100%;
        }

        /* Legend */
        #graph-legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 220px;
            border: 2px solid #e0e0e0;
            transition: opacity 0.3s;
        }

        #graph-legend.collapsed {
            opacity: 0.3;
        }

        #graph-legend.collapsed:hover {
            opacity: 1;
        }

        #graph-legend h4 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #graph-legend-toggle {
            cursor: pointer;
            font-size: 12px;
            color: #667eea;
            font-weight: 500;
        }

        .legend-section {
            margin-bottom: 14px;
        }

        .legend-section:last-child {
            margin-bottom: 0;
        }

        .legend-section h5 {
            font-size: 11px;
            font-weight: 700;
            color: #6c757d;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            font-size: 12px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-node {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 2px solid;
            flex-shrink: 0;
        }

        .legend-node.marker {
            background-color: #90CAF9;
            border-color: #1976D2;
        }

        .legend-node.pattern {
            background-color: #A5D6A7;
            border-color: #388E3C;
        }

        .legend-node.condition {
            background-color: #FFCC80;
            border-color: #F57C00;
        }

        .legend-node.test {
            background-color: #CE93D8;
            border-color: #7B1FA2;
        }

        .legend-edge {
            width: 40px;
            height: 3px;
            flex-shrink: 0;
            position: relative;
        }

        .legend-edge::after {
            content: '';
            position: absolute;
            right: -6px;
            top: -3px;
            width: 0;
            height: 0;
            border-left: 6px solid;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }

        .legend-edge.supports {
            background-color: #4CAF50;
        }

        .legend-edge.supports::after {
            border-left-color: #4CAF50;
        }

        .legend-edge.contradicts {
            background-color: #f44336;
        }

        .legend-edge.contradicts::after {
            border-left-color: #f44336;
        }

        .legend-edge.recommends {
            background-color: #FF9800;
            border-style: dashed;
        }

        .legend-edge.recommends::after {
            border-left-color: #FF9800;
        }

        .legend-edge.causal {
            background-color: #2196F3;
        }

        .legend-edge.causal::after {
            border-left-color: #2196F3;
        }

        /* Agent Activity Panel */
        #agent-activity {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
            z-index: 100;
            min-width: 280px;
            max-width: 400px;
            max-height: 500px;
            overflow-y: auto;
            border: 2px solid #e0e0e0;
        }

        #agent-activity h4 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #495057;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #agent-content {
            font-size: 12px;
        }

        .agent-call-item {
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-radius: 8px;
            border-left: 4px solid #2196F3;
        }

        .agent-call-item.rule-based {
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            border-left-color: #9E9E9E;
        }

        .agent-call-item h6 {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 4px;
            color: #1976D2;
        }

        .agent-call-item.rule-based h6 {
            color: #616161;
        }

        .agent-call-item .agent-type {
            font-weight: 600;
            text-transform: capitalize;
        }

        .agent-call-item .agent-time {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
        }

        .agent-call-item .agent-rationale {
            font-size: 11px;
            color: #424242;
            margin-top: 4px;
            font-style: italic;
        }

        /* Graph animation styles - will be applied via Cytoscape */
        .node-highlight {
            animation: nodePulse 1.5s ease-in-out infinite;
        }

        @keyframes nodePulse {
            0%, 100% { 
                transform: scale(1);
                filter: drop-shadow(0 0 8px rgba(76, 175, 80, 0.8));
            }
            50% { 
                transform: scale(1.15);
                filter: drop-shadow(0 0 20px rgba(76, 175, 80, 1));
            }
        }

        .edge-highlight {
            animation: edgeFlow 2s ease-in-out infinite;
        }

        @keyframes edgeFlow {
            0% { 
                opacity: 0.6;
                stroke-width: 3px;
            }
            50% { 
                opacity: 1;
                stroke-width: 5px;
            }
            100% { 
                opacity: 0.6;
                stroke-width: 3px;
            }
        }

        /* Right panel */
        #right {
            width: 380px;
            background: white;
            border-left: 2px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .tab-buttons {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .tab-button {
            flex: 1;
            padding: 14px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            position: relative;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }

        .tab-button.active {
            background: white;
            color: #667eea;
        }

        .tab-button.active::after {
            width: 100%;
        }

        .tab-content {
            display: none;
            padding: 16px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        /* Hypothesis card */
        .hypothesis-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 14px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .hypothesis-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .hypothesis-card h4 {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #212529;
        }

        .hypothesis-card .confidence {
            display: inline-block;
            padding: 6px 12px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(76, 175, 80, 0.3);
        }

        .hypothesis-card .confidence.high-confidence {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        }

        .hypothesis-card .confidence.medium-confidence {
            background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
            box-shadow: 0 2px 6px rgba(255, 152, 0, 0.3);
        }

        .hypothesis-card .confidence.low-confidence {
            background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);
            box-shadow: 0 2px 6px rgba(158, 158, 158, 0.3);
        }

        .hypothesis-card .next-tests {
            margin-top: 14px;
            padding-top: 14px;
            border-top: 2px solid #e0e0e0;
        }

        .hypothesis-card .next-tests h5 {
            font-size: 13px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #495057;
        }

        .hypothesis-card .next-tests ul {
            list-style: none;
            font-size: 13px;
            color: #6c757d;
        }

        .hypothesis-card .next-tests li {
            padding: 6px 0;
            padding-left: 20px;
            position: relative;
        }

        .hypothesis-card .next-tests li::before {
            content: '‚Üí';
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        /* Patient action card */
        .action-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            border-left: 5px solid #2196F3;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .action-card:hover {
            transform: translateX(4px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .action-card .task {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 6px;
            color: #212529;
        }

        .action-card .why {
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 8px;
        }

        .action-card .risk {
            display: inline-block;
            margin-top: 8px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .action-card .risk.low {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            color: #2e7d32;
        }

        .action-card .risk.medium {
            background: linear-gradient(135deg, #ffe082 0%, #ffcc02 100%);
            color: #f57c00;
        }

        .action-card .risk.high {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
            color: #c62828;
        }

        /* Reasoning trace */
        #reasoning-trace {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e0e0e0;
        }

        #reasoning-trace-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            cursor: pointer;
            user-select: none;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }

        #reasoning-trace-toggle:hover {
            background: #f5f5f5;
        }

        #reasoning-trace-toggle input {
            cursor: pointer;
            width: 18px;
            height: 18px;
        }

        #reasoning-trace-content {
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        #reasoning-trace-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        .evidence-item {
            padding: 10px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 8px;
            font-size: 12px;
            border-left: 4px solid #4CAF50;
            transition: all 0.2s;
        }

        .evidence-item:hover {
            transform: translateX(4px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .evidence-item .edge-id {
            font-family: 'Courier New', monospace;
            color: #6c757d;
            font-size: 11px;
            margin-top: 4px;
        }

        /* Trust Moments */
        #trust-moments {
            position: fixed;
            top: 90px;
            right: 20px;
            width: 420px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .trust-moment {
            background: white;
            border-radius: 12px;
            padding: 18px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(120%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .guardrail-fail {
            border-left: 6px solid #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #f44336;
        }

        .guardrail-fail h4 {
            color: #c62828;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .guardrail-fail .rule-id {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .guardrail-fail .message {
            font-size: 13px;
            color: #212529;
            line-height: 1.5;
        }

        .patch-diff {
            border-left: 6px solid #FF9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border-color: #FF9800;
        }

        .patch-diff h4 {
            color: #e65100;
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diff-section {
            margin-bottom: 14px;
        }

        .diff-section h5 {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #6c757d;
        }

        .diff-before, .diff-after {
            padding: 10px;
            border-radius: 6px;
            font-size: 11px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.4;
        }

        .diff-before {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
            color: #c62828;
            margin-bottom: 6px;
            border: 1px solid #ef9a9a;
        }

        .diff-after {
            background: linear-gradient(135deg, #c8e6c9 0%, #a5d6a7 100%);
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <h1>üß¨ med-EVE (Evidence Vector Engine) Medical AI</h1>
        <div id="model-status" class="lite" title="Click to check model status">
            <span class="status-dot"></span>
            <span id="model-status-text">Lite Mode</span>
        </div>
        <button id="demo-mode-btn" onclick="runDemoMode()">üé¨ Demo Mode</button>
        <div id="case-selector">
            <label for="case-select">Case:</label>
            <select id="case-select"></select>
            <button onclick="loadSelectedCase()">Load</button>
        </div>
    </div>

    <!-- Analyze from text (MedGemma pipeline, same traces/graph as case load) -->
    <div id="analyze-panel" style="background: #fff; border-bottom: 1px solid #e0e0e0; padding: 12px 20px;">
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <strong style="color: #5c6bc0;">Analyze from text</strong>
            <span style="font-size: 12px; color: #6c757d;">Paste lab values (e.g. Ferritin 12 ng/mL, Hb 10.5 g/dL). Uses local MedGemma.</span>
        </div>
        <div style="display: flex; gap: 10px; align-items: flex-start;">
            <textarea id="analyze-text" placeholder="e.g. Ferritin 12 ng/mL, Hb 10.5 g/dL, MCV 75. TSH 2.6 mIU/L. Patient vegan, fatigue." rows="2" style="flex: 1; padding: 10px; border: 1px solid #e0e0e0; border-radius: 6px; font-size: 14px; resize: vertical; min-width: 200px;"></textarea>
            <button id="analyze-btn" onclick="runFromText()" style="padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; white-space: nowrap;">Analyze</button>
        </div>
        <div style="display: flex; align-items: center; gap: 12px; margin-top: 8px;">
            <label style="font-size: 13px;"><input type="radio" name="analyze-mode" value="new" id="analyze-mode-new" checked> New case</label>
            <label style="font-size: 13px;"><input type="radio" name="analyze-mode" value="merge" id="analyze-mode-merge"> Add/update to current case</label>
            <span id="analyze-merge-hint" style="font-size: 11px; color: #999;">(no current case)</span>
        </div>
    </div>

    <!-- Run status: current case and saved output path -->
    <div id="run-status" style="padding: 8px 20px; background: #f8f9fa; border-bottom: 1px solid #e0e0e0; font-size: 12px; display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
        <span>Current case: <span id="current-case-label">none</span></span>
        <span>Saved to: <span id="output-path-label">‚Äî</span></span>
        <button type="button" id="clear-current-case-btn" onclick="clearCurrentCase()" style="margin-left: auto; padding: 4px 10px; font-size: 11px; border: 1px solid #dee2e6; background: #fff; border-radius: 4px; cursor: pointer;">Clear current case</button>
    </div>

    <!-- Timeline -->
    <div id="timeline">
        <div class="step-chip" data-step="LAB_NORMALIZE">
            <span>Lab Normalize</span>
            <span class="step-duration" id="duration-LAB_NORMALIZE"></span>
        </div>
        <div class="step-chip" data-step="CONTEXT_SELECT">
            <span>Context Select</span>
            <span class="step-duration" id="duration-CONTEXT_SELECT"></span>
        </div>
        <div class="step-chip" data-step="EVIDENCE_SCORE">
            <span>Evidence Score</span>
            <span class="step-duration" id="duration-EVIDENCE_SCORE"></span>
        </div>
        <div class="step-chip" data-step="REASON">
            <span>Reason</span>
            <span class="step-duration" id="duration-REASON"></span>
        </div>
        <div class="step-chip" data-step="GUARDRAILS">
            <span>Guardrails</span>
            <span class="step-duration" id="duration-GUARDRAILS"></span>
        </div>
        <div class="step-chip" data-step="FINAL">
            <span>Final</span>
            <span class="step-duration" id="duration-FINAL"></span>
        </div>
        <div id="playback-controls">
            <button id="play-pause-btn" onclick="togglePlayPause()">‚ñ∂ Play</button>
            <button onclick="replay()">‚Üª Replay</button>
            <button onclick="jumpToEnd()">‚è≠ Jump to End</button>
        </div>
    </div>

    <!-- Main layout -->
    <div id="main">
        <!-- Left: Abnormal labs -->
        <div id="left">
            <h3>Abnormal Labs</h3>
            <div id="abnormal-labs"></div>
        </div>

        <!-- Center: Graph -->
        <div id="center">
            <div id="cy"></div>
            <!-- Legend -->
            <div id="graph-legend">
                <h4>
                    <span>Graph Legend</span>
                    <span id="legend-toggle" class="legend-toggle" onclick="toggleLegend()">‚àí</span>
                </h4>
                <div id="legend-content">
                    <div class="legend-section">
                        <h5>Node Types</h5>
                        <div class="legend-item">
                            <div class="legend-node marker"></div>
                            <span>Marker (Lab Value)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-node pattern"></div>
                            <span>Pattern</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-node condition"></div>
                            <span>Condition</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-node test"></div>
                            <span>Test</span>
                        </div>
                    </div>
                    <div class="legend-section">
                        <h5>Edge Types</h5>
                        <div class="legend-item">
                            <div class="legend-edge supports"></div>
                            <span>Supports</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-edge contradicts"></div>
                            <span>Contradicts</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-edge recommends"></div>
                            <span>Recommends Test</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-edge causal"></div>
                            <span>Causal (Increases/Decreases)</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Agent Activity Panel -->
            <div id="agent-activity" style="display: none;">
                <h4>
                    <span>Agent Activity</span>
                    <span id="agent-toggle" onclick="toggleAgentActivity()" style="cursor: pointer; color: #667eea;">‚àí</span>
                </h4>
                <div id="agent-content"></div>
            </div>
        </div>

        <!-- Right: Tabs -->
        <div id="right">
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('clinician')">Clinician</button>
                <button class="tab-button" onclick="showTab('patient')">Patient</button>
                <button class="tab-button" onclick="showTab('guidance')">Guidance</button>
                <button class="tab-button" onclick="showTab('next-steps')">Next Steps</button>
            </div>
            <div id="clinician" class="tab-content active">
                <h3>Hypotheses</h3>
                <div id="hypotheses"></div>
                <div id="reasoning-trace">
                    <div id="reasoning-trace-toggle">
                        <input type="checkbox" id="trace-checkbox" onclick="toggleReasoningTrace(event)">
                        <label for="trace-checkbox" onclick="toggleReasoningTrace(event)">Show Reasoning Trace</label>
                    </div>
                    <div id="reasoning-trace-content"></div>
                </div>
            </div>
            <div id="patient" class="tab-content">
                <h3>Patient Actions</h3>
                <div id="actions"></div>
            </div>
            <div id="guidance" class="tab-content">
                <h3>Step-by-Step Guidance</h3>
                <div id="guidance-content">
                    <div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">
                        Load a case to see step-by-step guidance
                    </div>
                </div>
            </div>
            <div id="next-steps" class="tab-content">
                <h3>Recommended Next Steps</h3>
                <div id="next-steps-content">
                    <div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">
                        Load a case to see recommended next steps
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trust Moments -->
    <div id="trust-moments"></div>

    <script>
        let cy;
        let events = [];
        let currentEventIndex = 0;
        let isPlaying = false;
        let playInterval = null;
        let pipelineData = null;
        let stepDurations = {};
        let highlightedNodes = new Set();
        let highlightedEdges = new Set();
        let animationTimeouts = [];

        const API_BASE = 'http://localhost:8000';
        let modelHealth = null;
        let lastCurrentCaseId = null;

        function updateCurrentCaseDisplay(caseId) {
            lastCurrentCaseId = caseId || null;
            const el = document.getElementById('current-case-label');
            if (el) el.textContent = caseId || 'none';
            updateAnalyzeMergeState();
        }

        function updateOutputPathDisplay(path) {
            const el = document.getElementById('output-path-label');
            if (el) el.textContent = path || '‚Äî';
        }

        function updateAnalyzeMergeState() {
            const mergeRadio = document.getElementById('analyze-mode-merge');
            const hint = document.getElementById('analyze-merge-hint');
            if (!mergeRadio || !hint) return;
            if (lastCurrentCaseId) {
                mergeRadio.disabled = false;
                hint.textContent = '(merge with current)';
            } else {
                mergeRadio.disabled = true;
                if (document.getElementById('analyze-mode-merge')?.checked) {
                    document.getElementById('analyze-mode-new').checked = true;
                }
                hint.textContent = '(no current case)';
            }
        }

        async function clearCurrentCase() {
            try {
                const res = await fetch(`${API_BASE}/current-case`, { method: 'DELETE' });
                if (res.ok) {
                    updateCurrentCaseDisplay(null);
                }
            } catch (e) {
                console.error('Clear current case failed:', e);
            }
        }

        async function refreshCurrentCaseFromBackend() {
            try {
                const res = await fetch(`${API_BASE}/current-case`);
                if (res.ok) {
                    const data = await res.json();
                    updateCurrentCaseDisplay(data ? data.case_id : null);
                }
            } catch (e) {
                updateCurrentCaseDisplay(null);
            }
        }

        // Check model status
        async function checkModelStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    modelHealth = await response.json();
                    updateModelStatusIndicator();
                }
            } catch (error) {
                console.error('Failed to check model status:', error);
                modelHealth = null;
                updateModelStatusIndicator();
            }
        }
        
        // Add click handler for model status
        document.addEventListener('DOMContentLoaded', function() {
            const statusEl = document.getElementById('model-status');
            if (statusEl) {
                statusEl.addEventListener('click', function() {
                    checkModelStatus();
                });
                statusEl.style.cursor = 'pointer';
            }
        });

        function getModelTypeDisplay(modelName) {
            if (!modelName) return 'MedGemma';
            const parts = String(modelName).split('/');
            return parts[parts.length - 1] || modelName;
        }

        function updateModelStatusIndicator() {
            const statusEl = document.getElementById('model-status');
            const textEl = document.getElementById('model-status-text');
            const modelType = modelHealth ? getModelTypeDisplay(modelHealth.model_name) : '';

            if (!modelHealth) {
                statusEl.className = 'lite';
                textEl.textContent = 'Lite Mode';
                statusEl.title = 'Model status unknown - click to refresh';
                return;
            }

            // Loading: MODE=model and model is currently loading
            if (modelHealth.model_loading) {
                statusEl.className = 'loading';
                textEl.textContent = 'Model loading. Please wait..';
                statusEl.title = `Model: ${modelType}\nLoading in progress. Pipeline will start when ready.\nClick to refresh`;
                return;
            }

            // Loaded: model is active
            if (modelHealth.model_loaded && !modelHealth.lite_mode) {
                statusEl.className = 'active';
                const device = modelHealth.device || 'CPU';
                textEl.textContent = `Model Active (${device}) ¬∑ ${modelType}`;
                statusEl.title = `Model: ${modelType}\nDevice: ${device}\nCache: ${modelHealth.cache_size || 0} entries\nClick to refresh`;
                return;
            }

            // Model mode set but not loaded yet (e.g. load failed or not started)
            if (!modelHealth.lite_mode && !modelHealth.model_loaded) {
                statusEl.className = 'loading';
                textEl.textContent = 'Model mode ¬∑ waiting for model..';
                statusEl.title = `Model: ${modelType}\nModel mode enabled. Load in progress or will start on first run.\nClick to refresh`;
                return;
            }

            // Lite mode
            statusEl.className = 'lite';
            textEl.textContent = 'Lite Mode';
            const device = modelHealth.device || 'unknown';
            statusEl.title = `Using rule-based reasoning (no model).\nDevice: ${device}\n\nTo enable model:\n1. Stop the backend\n2. Run: export MODE=model\n3. Restart the backend\n\nClick to refresh status`;
        }

        // Initialize
        async function init() {
            try {
                await checkModelStatus();
                await loadCases();
                
                await refreshCurrentCaseFromBackend();
                // If MODE=model and model is loading, wait for it before auto-running so UI shows loading state
                if (modelHealth && !modelHealth.lite_mode && (modelHealth.model_loading || !modelHealth.model_loaded)) {
                    updateModelStatusIndicator();
                    await waitForModelReady();
                    await checkModelStatus();
                }
                
                // Check URL parameters for auto-load and autoplay
                const urlParams = new URLSearchParams(window.location.search);
                const caseParam = urlParams.get('case');
                const autoplayParam = urlParams.get('autoplay');
                
                if (caseParam) {
                    const select = document.getElementById('case-select');
                    if (select) {
                        select.value = caseParam;
                    }
                    const autoPlay = autoplayParam === 'true';
                    await runCase(caseParam, autoPlay);
                } else {
                    // Default: load gotcha case with autoplay if no case specified
                    await runCase('case_02_anemia_of_inflammation_gotcha', true);
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('hypotheses').innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">
                    <strong>Initialization Error</strong><br>
                    ${error.message}<br>
                    <small>Check browser console for details</small>
                </div>`;
            }
        }

        async function loadCases() {
            try {
                const response = await fetch(`${API_BASE}/cases`);
                if (!response.ok) {
                    throw new Error(`Failed to load cases: HTTP ${response.status}`);
                }
                const cases = await response.json();
                const select = document.getElementById('case-select');
                if (select) {
                    select.innerHTML = '';
                    cases.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.id;
                        select.appendChild(option);
                    });
                    select.value = 'case_02_anemia_of_inflammation_gotcha';
                }
            } catch (error) {
                console.error('Failed to load cases:', error);
                // Continue anyway - user can still try to load a case manually
            }
        }

        async function loadSelectedCase() {
            const caseId = document.getElementById('case-select').value;
            await runCase(caseId, true);  // Auto-play by default when loading
        }

        async function runDemoMode() {
            await runCase('case_02_anemia_of_inflammation_gotcha', true);
        }

        const MODEL_READY_POLL_MS = 500;
        const MODEL_READY_TIMEOUT_MS = 310000; // Slightly above backend 300s

        async function waitForModelReady() {
            const start = Date.now();
            while (Date.now() - start < MODEL_READY_TIMEOUT_MS) {
                const res = await fetch(`${API_BASE}/health`);
                if (!res.ok) throw new Error('Health check failed');
                const health = await res.json();
                modelHealth = health;
                updateModelStatusIndicator();
                if (health.model_loading) {
                    await new Promise(r => setTimeout(r, MODEL_READY_POLL_MS));
                    continue;
                }
                if (health.lite_mode) return;
                if (health.model_loaded) return;
                await new Promise(r => setTimeout(r, MODEL_READY_POLL_MS));
            }
            throw new Error('Model did not become ready in time. Check server logs.');
        }

        async function runCase(caseId, autoPlay = false) {
            try {
                resetUI();
                
                // Show loading state
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Loading case...</div>';
                
                // When model mode, wait for model to be ready before calling /run
                const healthRes = await fetch(`${API_BASE}/health`).catch(() => null);
                if (healthRes && healthRes.ok) {
                    const health = await healthRes.json();
                    modelHealth = health;
                    updateModelStatusIndicator();
                    if (!health.lite_mode && (health.model_loading || !health.model_loaded)) {
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #856404;">Model loading. Please wait..</div>';
                        const demoBtn = document.getElementById('demo-mode-btn');
                        const loadBtn = document.querySelector('#case-selector button');
                        const caseSelect = document.getElementById('case-select');
                        if (demoBtn) demoBtn.disabled = true;
                        if (loadBtn) loadBtn.disabled = true;
                        if (caseSelect) caseSelect.disabled = true;
                        try {
                            await waitForModelReady();
                        } finally {
                            if (demoBtn) demoBtn.disabled = false;
                            if (loadBtn) loadBtn.disabled = false;
                            if (caseSelect) caseSelect.disabled = false;
                        }
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Loading case...</div>';
                    }
                }
                
                const response = await fetch(`${API_BASE}/run`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ case_id: caseId })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                pipelineData = await response.json();
                
                if (!pipelineData || !pipelineData.evidence_bundle) {
                    throw new Error('Invalid response from backend');
                }
                
                events = pipelineData.events || [];
                
                // Refresh health check immediately after a run to get accurate model status
                await checkModelStatus();
                
                renderInitial(pipelineData);
                updateCurrentCaseDisplay(pipelineData.current_case_id ?? pipelineData.case_id);
                updateOutputPathDisplay(pipelineData.output_path ?? null);
                if (autoPlay) {
                    setTimeout(() => {
                        playEvents();
                    }, 800);
                }
            } catch (error) {
                console.error('Failed to run case:', error);
                const is503 = error.message && error.message.includes('503');
                const msg = is503
                    ? 'Model did not finish loading in time. Please try again or check server logs.'
                    : error.message;
                document.getElementById('hypotheses').innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">
                    <strong>Error loading case</strong><br>
                    ${msg}<br>
                    <small>Make sure the backend is running on http://localhost:8000</small>
                </div>`;
                alert(`Failed to load case: ${msg}\n\nMake sure the backend is running on http://localhost:8000`);
            }
        }

        async function runFromText(autoPlay = true) {
            const textarea = document.getElementById('analyze-text');
            const text = (textarea && textarea.value) ? textarea.value.trim() : '';
            if (!text) {
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #856404;">Enter or paste lab text above, then click Analyze.</div>';
                return;
            }
            try {
                resetUI();
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Analyzing text...</div>';
                const healthRes = await fetch(`${API_BASE}/health`).catch(() => null);
                if (healthRes && healthRes.ok) {
                    const health = await healthRes.json();
                    modelHealth = health;
                    updateModelStatusIndicator();
                    if (!health.lite_mode && (health.model_loading || !health.model_loaded)) {
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #856404;">Model loading. Please wait..</div>';
                        const analyzeBtn = document.getElementById('analyze-btn');
                        if (analyzeBtn) analyzeBtn.disabled = true;
                        try {
                            await waitForModelReady();
                        } finally {
                            if (analyzeBtn) analyzeBtn.disabled = false;
                        }
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Analyzing text...</div>';
                    }
                }
                const mergeWithCurrent = document.getElementById('analyze-mode-merge')?.checked === true;
                const response = await fetch(`${API_BASE}/analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text, merge_with_current: mergeWithCurrent })
                });
                if (!response.ok) {
                    const errBody = await response.json().catch(() => ({}));
                    const detail = errBody.detail || response.statusText;
                    throw new Error(detail);
                }
                pipelineData = await response.json();
                if (!pipelineData || !pipelineData.evidence_bundle) {
                    throw new Error('Invalid response from backend');
                }
                events = pipelineData.events || [];
                await checkModelStatus();
                renderInitial(pipelineData);
                updateCurrentCaseDisplay(pipelineData.current_case_id ?? pipelineData.case_id);
                updateOutputPathDisplay(pipelineData.output_path ?? null);
                if (autoPlay) {
                    setTimeout(() => playEvents(), 800);
                }
            } catch (error) {
                console.error('Analyze failed:', error);
                const msg = error.message || 'Analyze failed';
                document.getElementById('hypotheses').innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">
                    <strong>Analyze error</strong><br>${msg}<br>
                    <small>Try listing labs like: Ferritin 12 ng/mL, Hb 10.5 g/dL, TSH 2.6 mIU/L</small>
                </div>`;
            }
        }

        function resetUI() {
            currentEventIndex = 0;
            isPlaying = false;
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            // Clear all animation timeouts
            animationTimeouts.forEach(timeout => clearTimeout(timeout));
            animationTimeouts = [];
            
            document.querySelectorAll('.step-chip').forEach(chip => {
                chip.classList.remove('active', 'completed');
            });
            document.getElementById('play-pause-btn').textContent = '‚ñ∂ Play';
            document.getElementById('play-pause-btn').classList.remove('active');
            document.getElementById('trust-moments').innerHTML = '';
            highlightedNodes.clear();
            highlightedEdges.clear();
            
            // Reset reasoning trace
            const traceCheckbox = document.getElementById('trace-checkbox');
            const traceContent = document.getElementById('reasoning-trace-content');
            if (traceCheckbox) {
                traceCheckbox.checked = false;
            }
            if (traceContent) {
                traceContent.classList.remove('active');
                traceContent.innerHTML = '';
            }
            
            // Clear hypotheses and actions
            document.getElementById('hypotheses').innerHTML = '';
            document.getElementById('actions').innerHTML = '';
        }

        function renderInitial(data) {
            // Render abnormal labs
            const abnormalLabs = data.normalized_labs.filter(lab => lab.status !== 'NORMAL');
            const labsHtml = abnormalLabs.map(lab => `
                <div class="lab-item ${lab.status}" data-marker="${lab.marker}">
                    <div class="marker-name">${lab.marker}</div>
                    <div class="lab-value">${lab.value} ${lab.unit} (${lab.status})</div>
                </div>
            `).join('');
            document.getElementById('abnormal-labs').innerHTML = labsHtml;

            // Build graph with enhanced styling
            const elements = [];
            const nodeMap = {};
            
            data.evidence_bundle.subgraph.nodes.forEach(node => {
                nodeMap[node.id] = node;
                const nodeData = {
                    id: node.id,
                    label: node.label,
                    type: node.type
                };
                if (node.dynamic === true) nodeData.dynamic = true;
                elements.push({ data: nodeData });
            });

            data.evidence_bundle.subgraph.edges.forEach(edge => {
                const source = edge.from_ || edge.from;
                elements.push({
                    data: {
                        id: edge.id,
                        source: source,
                        target: edge.to,
                        label: edge.relation,
                        relation: edge.relation
                    }
                });
            });

            // Initialize Cytoscape with beautiful styling
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': '70px',
                            'height': '70px',
                            'background-color': '#e0e0e0',
                            'color': '#333',
                            'font-size': '13px',
                            'font-weight': '600',
                            'text-wrap': 'wrap',
                            'text-max-width': '90px',
                            'border-width': 3,
                            'border-color': '#999',
                            'shape': 'round-rectangle',
                            'transition-property': 'background-color, border-color, width, height, filter, shape',
                            'transition-duration': '0.4s',
                            'transition-timing-function': 'cubic-bezier(0.4, 0, 0.2, 1)'
                        }
                    },
                    {
                        selector: 'node[type="Marker"]',
                        style: {
                            'background-color': '#90CAF9',
                            'border-color': '#1976D2',
                            'background-opacity': 0.95,
                            'shape': 'round-rectangle'
                        }
                    },
                    {
                        selector: 'node[type="Pattern"]',
                        style: {
                            'background-color': '#A5D6A7',
                            'border-color': '#388E3C',
                            'background-opacity': 0.95,
                            'shape': 'ellipse'
                        }
                    },
                    {
                        selector: 'node[type="Condition"]',
                        style: {
                            'background-color': '#FFCC80',
                            'border-color': '#F57C00',
                            'background-opacity': 0.95,
                            'shape': 'round-octagon'
                        }
                    },
                    {
                        selector: 'node[type="Test"]',
                        style: {
                            'background-color': '#CE93D8',
                            'border-color': '#7B1FA2',
                            'background-opacity': 0.95,
                            'shape': 'diamond'
                        }
                    },
                    {
                        selector: 'node[dynamic]',
                        style: {
                            'border-width': 4,
                            'border-color': '#E65100',
                            'border-style': 'double',
                            'background-color': '#FFE0B2'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'label': 'data(label)',
                            'width': 2,
                            'line-color': '#999',
                            'target-arrow-color': '#999',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-size': '8px',
                            'curve-style': 'bezier',
                            'font-size': '10px',
                            'text-rotation': 'autorotate',
                            'text-margin-y': -12,
                            'opacity': 0.5,
                            'transition-property': 'line-color, width, opacity, target-arrow-color, line-style',
                            'transition-duration': '0.4s',
                            'transition-timing-function': 'cubic-bezier(0.4, 0, 0.2, 1)'
                        }
                    },
                    {
                        selector: 'edge[relation="SUPPORTS"]',
                        style: {
                            'line-color': '#4CAF50',
                            'target-arrow-color': '#4CAF50',
                            'width': 3,
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'edge[relation="CONTRADICTS"]',
                        style: {
                            'line-color': '#f44336',
                            'target-arrow-color': '#f44336',
                            'width': 3,
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'edge[relation="RECOMMENDS_TEST"]',
                        style: {
                            'line-color': '#FF9800',
                            'target-arrow-color': '#FF9800',
                            'width': 4,
                            'line-style': 'dashed',
                            'opacity': 0.8
                        }
                    },
                    {
                        selector: 'edge[relation="CAUSES"], edge[relation="INCREASES"], edge[relation="DECREASES"]',
                        style: {
                            'line-color': '#2196F3',
                            'target-arrow-color': '#2196F3',
                            'width': 3,
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'node.highlighted',
                        style: {
                            'background-color': '#4CAF50',
                            'border-color': '#2E7D32',
                            'border-width': 4,
                            'width': '85px',
                            'height': '85px',
                            'z-index': 999
                        }
                    },
                    {
                        selector: 'edge.highlighted',
                        style: {
                            'line-color': '#4CAF50',
                            'target-arrow-color': '#4CAF50',
                            'width': 6,
                            'opacity': 1,
                            'z-index': 998
                        }
                    },
                    {
                        selector: 'edge.conclusion-support',
                        style: {
                            'line-color': '#2E7D32',
                            'target-arrow-color': '#2E7D32',
                            'width': 5,
                            'opacity': 1,
                            'z-index': 997
                        }
                    },
                    {
                        selector: 'node.conclusion-recommended',
                        style: {
                            'background-color': '#7B1FA2',
                            'border-color': '#4A148C',
                            'border-width': 5,
                            'z-index': 996
                        }
                    },
                    {
                        selector: 'edge.conclusion-recommended',
                        style: {
                            'line-color': '#7B1FA2',
                            'target-arrow-color': '#7B1FA2',
                            'width': 5,
                            'line-style': 'dashed',
                            'opacity': 1,
                            'z-index': 995
                        }
                    },
                    {
                        selector: 'node.pulsing',
                        style: {
                            'background-color': '#66BB6A',
                            'border-color': '#4CAF50',
                            'border-width': 5
                        }
                    },
                    {
                        selector: 'edge.flowing',
                        style: {
                            'line-color': '#2196F3',
                            'target-arrow-color': '#2196F3',
                            'width': 5
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    idealEdgeLength: 120,
                    nodeOverlap: 25,
                    refresh: 20,
                    fit: true,
                    padding: 40,
                    randomize: false,
                    componentSpacing: 120,
                    nodeRepulsion: 4500000,
                    edgeElasticity: 120,
                    nestingFactor: 6,
                    gravity: 0.3,
                    numIter: 1200,
                    initialTemp: 250,
                    coolingFactor: 0.95,
                    minTemp: 1.5
                }
            });

            // Render hypotheses
            renderHypotheses(data.reasoner_output.hypotheses, data.evidence_bundle);

            // Render patient actions
            renderPatientActions(data.reasoner_output.patient_actions);

            // Extract step durations
            extractStepDurations();
            
            // Update reasoning trace if it was previously visible
            const traceCheckbox = document.getElementById('trace-checkbox');
            if (traceCheckbox && traceCheckbox.checked) {
                renderReasoningTrace();
            }
            
            // Render agent activity (will be called after events are processed)
            setTimeout(() => renderAgentActivity(), 100);
            
            // Render guidance and next steps
            renderGuidance(data);
            renderNextSteps(data);
        }

        function extractStepDurations() {
            stepDurations = {};
            const stepStartTimes = {};
            
            events.forEach(event => {
                if (event.type === 'STEP_START') {
                    stepStartTimes[event.step] = Date.now();
                } else if (event.type === 'STEP_END') {
                    const startTime = stepStartTimes[event.step];
                    if (startTime && event.payload.duration_ms) {
                        stepDurations[event.step] = event.payload.duration_ms;
                        const durationEl = document.getElementById(`duration-${event.step}`);
                        if (durationEl) {
                            durationEl.textContent = `(${Math.round(event.payload.duration_ms)}ms)`;
                        }
                    }
                }
            });
        }

        function renderHypotheses(hypotheses, evidenceBundle) {
            if (!hypotheses || hypotheses.length === 0) {
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">No hypotheses generated for this case.</div>';
                return;
            }
            
            // Sort hypotheses by confidence (descending) if not already sorted
            const sortedHypotheses = [...hypotheses].sort((a, b) => (b.confidence || 0) - (a.confidence || 0));
            
            const hypothesesHtml = sortedHypotheses.map((hypo, idx) => {
                const nextTests = hypo.next_tests || [];
                const nextTestsList = Array.isArray(nextTests) && nextTests.length > 0 
                    ? nextTests.map(test => {
                        const testLabel = typeof test === 'string' ? test : (test.label || test.test_id || test);
                        const testRationale = typeof test === 'object' && test.rationale ? ` <span style="font-size: 10px; color: #666; font-style: italic;">(${test.rationale})</span>` : '';
                        return `<li>${testLabel}${testRationale}</li>`;
                    }).join('')
                    : '<li>None</li>';
                
                // Color code confidence badge
                const confidence = hypo.confidence || 0;
                let confidenceClass = 'confidence';
                let confidenceLabel = '';
                if (confidence >= 0.7) {
                    confidenceClass += ' high-confidence';
                    confidenceLabel = 'Very likely';
                } else if (confidence >= 0.4) {
                    confidenceClass += ' medium-confidence';
                    confidenceLabel = 'Possible';
                } else {
                    confidenceClass += ' low-confidence';
                    confidenceLabel = 'Unlikely';
                }
                
                // Show evidence count
                const evidenceCount = (hypo.evidence || []).length;
                const counterEvidenceCount = (hypo.counter_evidence || []).length;
                
                // What would change my mind
                const changeMind = hypo.what_would_change_my_mind || [];
                const changeMindHtml = changeMind.length > 0 ? `
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; border-left: 3px solid #667eea;">
                        <div style="font-size: 11px; font-weight: 600; color: #667eea; margin-bottom: 6px;">What would change my mind:</div>
                        <ul style="margin: 0; padding-left: 18px; font-size: 11px; color: #495057; line-height: 1.5;">
                            ${changeMind.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                ` : '';
                
                return `
                    <div class="hypothesis-card" data-hypothesis-id="${hypo.id || idx}" style="order: ${idx};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <h4 style="margin: 0;">${hypo.name}</h4>
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span class="${confidenceClass}">${Math.round(confidence * 100)}%</span>
                                <span style="font-size: 9px; color: #999; margin-top: 2px;">${confidenceLabel}</span>
                            </div>
                        </div>
                        ${evidenceCount > 0 || counterEvidenceCount > 0 ? `
                            <div style="font-size: 11px; color: #6c757d; margin-bottom: 10px;">
                                ${evidenceCount > 0 ? `<span style="color: #4CAF50;">‚úì ${evidenceCount} supporting</span>` : ''}
                                ${counterEvidenceCount > 0 ? `<span style="color: #f44336; margin-left: 8px;">‚úó ${counterEvidenceCount} contradicting</span>` : ''}
                            </div>
                        ` : ''}
                        ${nextTests.length > 0 ? `
                            <div class="next-tests" style="margin-bottom: 10px;">
                                <h5 style="font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 6px;">Recommended Tests:</h5>
                                <ul style="margin: 0; padding-left: 18px; font-size: 11px; color: #495057; line-height: 1.5;">${nextTestsList}</ul>
                            </div>
                        ` : ''}
                        ${changeMindHtml}
                    </div>
                `;
            }).join('');
            
            document.getElementById('hypotheses').innerHTML = hypothesesHtml;
        }

        function renderPatientActions(actions) {
            if (!actions || actions.length === 0) {
                document.getElementById('actions').innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">No patient actions recommended for this case.</div>';
                return;
            }
            
            // Sort by risk level (high -> medium -> low)
            const riskOrder = { 'high': 0, 'medium': 1, 'low': 2, 'none': 3 };
            const sortedActions = [...actions].sort((a, b) => {
                const aRisk = riskOrder[a.risk] ?? 3;
                const bRisk = riskOrder[b.risk] ?? 3;
                return aRisk - bRisk;
            });
            
            const actionsHtml = sortedActions.map(action => {
                const bucket = action.bucket || 'general';
                const bucketLabels = {
                    'immediate': 'Immediate',
                    'short_term': 'Short-term',
                    'monitoring': 'Monitoring',
                    'lifestyle': 'Lifestyle',
                    'general': 'General'
                };
                return `
                    <div class="action-card" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <div class="task" style="flex: 1;">${action.task}</div>
                            ${action.risk ? `<span class="risk ${action.risk}" style="margin-left: 8px;">${action.risk} risk</span>` : ''}
                        </div>
                        ${action.why ? `<div class="why" style="font-size: 12px; color: #666; margin-bottom: 6px;">${action.why}</div>` : ''}
                        ${bucket !== 'general' ? `<div style="font-size: 10px; color: #999; font-style: italic;">Category: ${bucketLabels[bucket] || bucket}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('actions').innerHTML = actionsHtml;
        }

        function renderGuidance(data) {
            const guidanceContent = document.getElementById('guidance-content');
            if (!data || !data.events) {
                guidanceContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Load a case to see step-by-step guidance</div>';
                return;
            }
            
            const events = data.events || [];
            const stepExplanations = {
                'LAB_NORMALIZE': {
                    title: 'Lab Normalization',
                    description: 'Converting raw lab values into standardized formats and identifying abnormal values that need attention.',
                    icon: 'üî¨'
                },
                'CONTEXT_SELECT': {
                    title: 'Context Selection',
                    description: 'Identifying relevant medical patterns and conditions from the knowledge graph based on abnormal lab values.',
                    icon: 'üéØ'
                },
                'EVIDENCE_SCORE': {
                    title: 'Evidence Scoring',
                    description: 'Evaluating how strongly each piece of evidence supports or contradicts potential diagnoses.',
                    icon: '‚öñÔ∏è'
                },
                'REASON': {
                    title: 'Reasoning',
                    description: 'Generating diagnostic hypotheses by combining evidence scores with medical knowledge.',
                    icon: 'üß†'
                },
                'GUARDRAILS': {
                    title: 'Safety Guardrails',
                    description: 'Checking recommendations against safety rules to prevent harmful actions.',
                    icon: 'üõ°Ô∏è'
                },
                'FINAL': {
                    title: 'Final Output',
                    description: 'Compiling final recommendations with safety checks applied.',
                    icon: '‚úÖ'
                }
            };
            
            let html = '';
            const completedSteps = new Set();
            events.forEach(event => {
                if (event.type === 'STEP_END') {
                    completedSteps.add(event.step);
                }
            });
            
            Object.keys(stepExplanations).forEach(step => {
                const info = stepExplanations[step];
                const isCompleted = completedSteps.has(step);
                const isActive = events.some(e => e.step === step && e.type === 'STEP_START' && !completedSteps.has(step));
                
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: ${isCompleted ? '#e8f5e9' : isActive ? '#e3f2fd' : '#f5f5f5'}; border-radius: 8px; border-left: 4px solid ${isCompleted ? '#4CAF50' : isActive ? '#2196F3' : '#ccc'};">
                        <div style="display: flex; align-items: center; margin-bottom: 6px;">
                            <span style="font-size: 18px; margin-right: 8px;">${info.icon}</span>
                            <h4 style="margin: 0; font-size: 14px; font-weight: 600; color: #333;">${info.title}</h4>
                            ${isCompleted ? '<span style="margin-left: auto; color: #4CAF50; font-size: 12px;">‚úì Complete</span>' : isActive ? '<span style="margin-left: auto; color: #2196F3; font-size: 12px;">In progress...</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: #666; line-height: 1.5;">${info.description}</div>
                    </div>
                `;
            });
            
            // Add gotcha case explanation if applicable
            const caseId = data.case_card?.case_id || '';
            if (caseId.includes('gotcha') || caseId.includes('inflammation')) {
                html += `
                    <div style="margin-top: 20px; padding: 14px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #FF9800;">
                        <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #e65100;">‚ö†Ô∏è Important: Anemia of Inflammation Case</h4>
                        <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                            <p style="margin: 0 0 8px 0;">This case demonstrates a common diagnostic challenge: <strong>high ferritin levels during inflammation</strong> can mask iron deficiency.</p>
                            <p style="margin: 0 0 8px 0;">The system detected that iron supplementation would be unsafe because:</p>
                            <ul style="margin: 0 0 8px 0; padding-left: 20px;">
                                <li>Ferritin is an acute-phase reactant (increases during inflammation)</li>
                                <li>Supplementing iron during active inflammation can worsen the condition</li>
                                <li>The underlying inflammation must be addressed first</li>
                            </ul>
                            <p style="margin: 0; font-weight: 600; color: #e65100;">The guardrail system automatically removed the unsafe iron supplementation recommendation.</p>
                        </div>
                    </div>
                `;
            }
            
            guidanceContent.innerHTML = html;
        }

        function renderNextSteps(data) {
            const nextStepsContent = document.getElementById('next-steps-content');
            if (!data || !data.reasoner_output) {
                nextStepsContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Load a case to see recommended next steps</div>';
                return;
            }
            
            const hypotheses = data.reasoner_output.hypotheses || [];
            const actions = data.reasoner_output.patient_actions || [];
            
            let html = '';
            
            // Priority tests
            const allTests = [];
            hypotheses.forEach(hypo => {
                (hypo.next_tests || []).forEach(test => {
                    const testName = typeof test === 'string' ? test : (test.label || test.test_id || test);
                    if (!allTests.includes(testName)) {
                        allTests.push(testName);
                    }
                });
            });
            
            if (allTests.length > 0) {
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
                        <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #1976D2;">üî¨ Priority Tests</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #424242; line-height: 1.6;">
                            ${allTests.map(test => `<li>${test}</li>`).join('')}
                        </ul>
                        <div style="margin-top: 8px; font-size: 11px; color: #666; font-style: italic;">Order these tests to help confirm or rule out the top hypotheses.</div>
                    </div>
                `;
            }
            
            // Monitoring recommendations
            const monitoringActions = actions.filter(a => a.bucket === 'monitoring' || (a.task && a.task.toLowerCase().includes('monitor')));
            if (monitoringActions.length > 0) {
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: #fff3e0; border-radius: 8px; border-left: 4px solid #FF9800;">
                        <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #e65100;">üìä Monitoring</h4>
                        <ul style="margin: 0; padding-left: 20px; font-size: 12px; color: #424242; line-height: 1.6;">
                            ${monitoringActions.map(a => `<li>${a.task}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Follow-up timing
            const topHypothesis = hypotheses[0];
            if (topHypothesis) {
                const confidence = topHypothesis.confidence || 0;
                let followUpTiming = '';
                if (confidence >= 0.7) {
                    followUpTiming = 'Schedule follow-up in 1-2 weeks to assess treatment response.';
                } else if (confidence >= 0.4) {
                    followUpTiming = 'Schedule follow-up in 2-4 weeks after diagnostic tests are completed.';
                } else {
                    followUpTiming = 'Consider follow-up in 4-6 weeks or sooner if symptoms worsen.';
                }
                
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: #f3e5f5; border-radius: 8px; border-left: 4px solid #9C27B0;">
                        <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #7B1FA2;">üìÖ Follow-up Timing</h4>
                        <div style="font-size: 12px; color: #424242; line-height: 1.6;">${followUpTiming}</div>
                    </div>
                `;
            }
            
            // Safety note if guardrails were applied
            if (data.guardrail_report && data.guardrail_report.failed_rules && data.guardrail_report.failed_rules.length > 0) {
                html += `
                    <div style="margin-bottom: 16px; padding: 12px; background: #ffebee; border-radius: 8px; border-left: 4px solid #f44336;">
                        <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #c62828;">üõ°Ô∏è Safety Note</h4>
                        <div style="font-size: 12px; color: #424242; line-height: 1.6;">
                            The system automatically removed unsafe recommendations. Review the "Guidance" tab for details about what was blocked and why.
                        </div>
                    </div>
                `;
            }
            
            if (!html) {
                html = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">No specific next steps available for this case.</div>';
            }
            
            nextStepsContent.innerHTML = html;
        }

        function playEvents() {
            if (isPlaying) return;
            
            isPlaying = true;
            document.getElementById('play-pause-btn').textContent = '‚è∏ Pause';
            document.getElementById('play-pause-btn').classList.add('active');
            
            playInterval = setInterval(() => {
                if (currentEventIndex < events.length) {
                    handleEvent(events[currentEventIndex]);
                    currentEventIndex++;
                } else {
                    pauseEvents();
                    // Finalize graph state after all events complete
                    setTimeout(() => {
                        finalizeGraphState();
                    }, 500);
                }
            }, 900);
        }

        function pauseEvents() {
            isPlaying = false;
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            document.getElementById('play-pause-btn').textContent = '‚ñ∂ Play';
            document.getElementById('play-pause-btn').classList.remove('active');
        }

        function togglePlayPause() {
            if (isPlaying) {
                pauseEvents();
            } else {
                playEvents();
            }
        }

        function replay() {
            currentEventIndex = 0;
            resetUI();
            // Reset graph to initial state with smooth fade
            if (cy) {
                cy.nodes().style({
                    'background-color': null,
                    'border-color': null,
                    'border-width': null,
                    'width': null,
                    'height': null
                }).removeClass('highlighted pulsing conclusion-support conclusion-recommended');
                cy.edges().style({
                    'line-color': null,
                    'target-arrow-color': null,
                    'width': null,
                    'opacity': null
                }).removeClass('highlighted flowing conclusion-support conclusion-recommended');
            }
            document.getElementById('trust-moments').innerHTML = '';
            document.querySelectorAll('.lab-item').forEach(item => {
                item.classList.remove('pulse');
            });
            document.querySelectorAll('.step-chip').forEach(chip => {
                chip.classList.remove('active', 'completed');
            });
            playEvents();
        }

        function jumpToEnd() {
            pauseEvents();
            currentEventIndex = events.length;
            events.forEach(event => handleEvent(event));
            document.querySelectorAll('.step-chip').forEach(chip => {
                chip.classList.add('completed');
                chip.classList.remove('active');
            });
            // Finalize graph state after all events
            setTimeout(() => {
                finalizeGraphState();
            }, 500);
        }

        function handleEvent(event) {
            const step = event.step;
            const type = event.type;
            
            updateTimeline(step, type);
            
            switch (type) {
                case 'HIGHLIGHT':
                    handleHighlight(event);
                    break;
                case 'GUARDRAIL_FAIL':
                    handleGuardrailFail(event);
                    break;
                case 'GUARDRAIL_PATCH_APPLIED':
                    handleGuardrailPatch(event);
                    break;
                case 'HYPOTHESIS_READY':
                    handleHypothesisReady(event);
                    break;
                case 'CANDIDATES':
                    handleCandidates(event);
                    break;
                case 'EVIDENCE_APPLIED':
                    handleEvidenceApplied(event);
                    break;
            }
        }

        function updateTimeline(step, type) {
            const chip = document.querySelector(`[data-step="${step}"]`);
            if (!chip) return;
            
            if (type === 'STEP_START') {
                chip.classList.add('active');
                chip.classList.remove('completed');
            } else if (type === 'STEP_END') {
                chip.classList.remove('active');
                chip.classList.add('completed');
            }
        }

        function handleHighlight(event) {
            const payload = event.payload || {};
            const nodeIds = payload.node_ids || [];
            const edgeIds = payload.edge_ids || [];
            
            // Smooth fade out previous highlights
            highlightedNodes.forEach(id => {
                const node = cy.getElementById(id);
                if (node.length) {
                    node.animate({
                        style: {
                            'background-color': null,
                            'border-color': null,
                            'border-width': 3,
                            'width': '70px',
                            'height': '70px'
                        }
                    }, {
                        duration: 400,
                        easing: 'ease-out'
                    });
                    node.removeClass('highlighted pulsing');
                }
            });
            
            highlightedEdges.forEach(id => {
                const edge = cy.getElementById(id);
                if (edge.length) {
                    edge.animate({
                        style: {
                            'line-color': null,
                            'target-arrow-color': null,
                            'width': 2,
                            'opacity': 0.6
                        }
                    }, {
                        duration: 400,
                        easing: 'ease-out'
                    });
                    edge.removeClass('highlighted flowing');
                }
            });
            
            highlightedNodes.clear();
            highlightedEdges.clear();
            
            // Animate new highlights with beautiful effects
            nodeIds.forEach((id, index) => {
                const node = cy.getElementById(id);
                if (node.length) {
                    // Stagger animation for multiple nodes
                    const timeout = setTimeout(() => {
                        node.addClass('highlighted');
                        node.animate({
                            style: {
                                'background-color': '#4CAF50',
                                'border-color': '#2E7D32',
                                'border-width': 5,
                                'width': '90px',
                                'height': '90px'
                            }
                        }, {
                            duration: 600,
                            easing: 'ease-out'
                        });
                        
                        // Add pulsing effect
                        setTimeout(() => {
                            node.addClass('pulsing');
                            // Remove pulsing after animation
                            setTimeout(() => node.removeClass('pulsing'), 2000);
                        }, 600);
                    }, index * 100);
                    animationTimeouts.push(timeout);
                    highlightedNodes.add(id);
                }
            });
            
            edgeIds.forEach((id, index) => {
                const edge = cy.getElementById(id);
                if (edge.length) {
                    const timeout = setTimeout(() => {
                        edge.addClass('highlighted');
                        edge.animate({
                            style: {
                                'line-color': '#4CAF50',
                                'target-arrow-color': '#4CAF50',
                                'width': 7,
                                'opacity': 1
                            }
                        }, {
                            duration: 600,
                            easing: 'ease-out'
                        });
                        
                        // Add flowing effect
                        setTimeout(() => {
                            edge.addClass('flowing');
                            setTimeout(() => edge.removeClass('flowing'), 2000);
                        }, 600);
                    }, (nodeIds.length * 100) + (index * 150));
                    animationTimeouts.push(timeout);
                    highlightedEdges.add(id);
                }
            });
            
            // Pulse lab items
            if (nodeIds.length > 0 && pipelineData) {
                const markerNodeIds = pipelineData.case_card?.abnormal_marker_node_ids || [];
                nodeIds.forEach((nodeId, idx) => {
                    if (markerNodeIds.includes(nodeId)) {
                        const markerNode = pipelineData.evidence_bundle.subgraph.nodes.find(n => n.id === nodeId);
                        if (markerNode) {
                            const labItem = document.querySelector(`[data-marker="${markerNode.label}"]`);
                            if (labItem) {
                                setTimeout(() => {
                                    labItem.classList.add('pulse');
                                    setTimeout(() => labItem.classList.remove('pulse'), 2000);
                                }, idx * 100);
                            }
                        }
                    }
                });
            }
        }

        function handleGuardrailFail(event) {
            const payload = event.payload || {};
            const failedRules = payload.failed_rules || [];
            
            const trustMoments = document.getElementById('trust-moments');
            const failCard = document.createElement('div');
            failCard.className = 'trust-moment guardrail-fail';
            
            let rulesHtml = '';
            if (failedRules.length > 0) {
                rulesHtml = failedRules.map(rule => {
                    const ruleId = rule.id || rule.rule_id || 'Unknown';
                    const message = rule.message || 'Guardrail check failed';
                    return `
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">
                            <div class="rule-id">Rule: ${ruleId}</div>
                            <div class="message">${message}</div>
                        </div>
                    `;
                }).join('');
            } else {
                rulesHtml = '<div class="message">Guardrail check failed</div>';
            }
            
            failCard.innerHTML = `
                <h4>‚ö†Ô∏è Guardrail Failed</h4>
                ${rulesHtml}
            `;
            trustMoments.appendChild(failCard);
            
            setTimeout(() => {
                failCard.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => failCard.remove(), 400);
            }, 10000);
        }

        function handleGuardrailPatch(event) {
            const payload = event.payload || {};
            const before = payload.before;
            const after = payload.after;
            
            if (!before || !after) return;
            
            const trustMoments = document.getElementById('trust-moments');
            const patchCard = document.createElement('div');
            patchCard.className = 'trust-moment patch-diff';
            
            // Get guardrail explanations from pipeline data if available
            const guardrailReport = pipelineData?.guardrail_report;
            const explanations = guardrailReport?.explanations || [];
            
            // Create human-readable explanation
            let explanationHtml = '';
            if (explanations.length > 0) {
                explanations.forEach(expl => {
                    explanationHtml += `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px; border-left: 3px solid #FF9800;">
                            <div style="font-weight: 600; color: #e65100; margin-bottom: 6px;">Safety Check: ${expl.rule_id || 'Guardrail'}</div>
                            <div style="font-size: 13px; line-height: 1.5; color: #424242; margin-bottom: 8px;">${expl.explanation || 'An unsafe recommendation was automatically removed.'}</div>
                            ${expl.risk_level ? `<div style="font-size: 11px; color: #666; margin-bottom: 6px;"><strong>Risk Level:</strong> ${expl.risk_level}</div>` : ''}
                            ${expl.alternative_actions && expl.alternative_actions.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 4px;">Safe Alternatives:</div>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #424242;">
                                        ${expl.alternative_actions.map(alt => `<li>${typeof alt === 'string' ? alt : alt.action || alt}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                // Fallback: create explanation from diff
                const removedActions = before.patient_actions?.filter(b => 
                    !after.patient_actions?.some(a => JSON.stringify(a) === JSON.stringify(b))
                ) || [];
                
                if (removedActions.length > 0) {
                    const action = removedActions[0];
                    explanationHtml = `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px; border-left: 3px solid #FF9800;">
                            <div style="font-weight: 600; color: #e65100; margin-bottom: 6px;">Safety Check: Unsafe Action Removed</div>
                            <div style="font-size: 13px; line-height: 1.5; color: #424242; margin-bottom: 8px;">
                                The system detected and automatically removed an unsafe recommendation: 
                                <strong>"${action.task || 'Unsafe action'}"</strong>
                            </div>
                            <div style="font-size: 11px; color: #666;">This action was blocked by safety guardrails to prevent potential harm to the patient.</div>
                        </div>
                    `;
                }
            }
            
            const diffHtml = createDiffHtml(before, after);
            
            patchCard.innerHTML = `
                <h4>üîß Safety Patch Applied</h4>
                ${explanationHtml}
                <div style="margin-top: 12px; font-size: 11px; color: #666; font-style: italic;">
                    The system automatically removed unsafe recommendations. See details below.
                </div>
                ${diffHtml}
            `;
            trustMoments.appendChild(patchCard);
            
            setTimeout(() => {
                patchCard.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => patchCard.remove(), 400);
            }, 20000); // Keep visible longer for important safety info
        }

        function createDiffHtml(before, after) {
            // Handle patient_actions array specifically
            if (before.patient_actions && after.patient_actions) {
                const removed = before.patient_actions.filter(b => 
                    !after.patient_actions.some(a => JSON.stringify(a) === JSON.stringify(b))
                );
                const added = after.patient_actions.filter(a => 
                    !before.patient_actions.some(b => JSON.stringify(b) === JSON.stringify(a))
                );
                
                let html = '';
                if (removed.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Removed (Unsafe Actions):</h5>
                            ${removed.map(item => `
                                <div class="diff-before" style="margin-bottom: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">- ${item.task || 'Action'}</div>
                                    ${item.why ? `<div style="font-size: 10px; opacity: 0.8;">Reason: ${item.why}</div>` : ''}
                                    ${item.bucket ? `<div style="font-size: 10px; opacity: 0.8;">Category: ${item.bucket}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                if (added.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Added (Safe Alternatives):</h5>
                            ${added.map(item => `
                                <div class="diff-after" style="margin-bottom: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">+ ${item.task || 'Action'}</div>
                                    ${item.why ? `<div style="font-size: 10px; opacity: 0.8;">Reason: ${item.why}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                return html || '<div class="diff-section" style="font-size: 11px; color: #666;">No changes to patient actions</div>';
            }
            
            // Generic array handling
            if (Array.isArray(before) && Array.isArray(after)) {
                const removed = before.filter(b => !after.some(a => JSON.stringify(a) === JSON.stringify(b)));
                const added = after.filter(a => !before.some(b => JSON.stringify(b) === JSON.stringify(a)));
                
                let html = '';
                if (removed.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Removed:</h5>
                            ${removed.map(item => `
                                <div class="diff-before">- ${JSON.stringify(item, null, 2)}</div>
                            `).join('')}
                        </div>
                    `;
                }
                if (added.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Added:</h5>
                            ${added.map(item => `
                                <div class="diff-after">+ ${JSON.stringify(item, null, 2)}</div>
                            `).join('')}
                        </div>
                    `;
                }
                return html || '<div class="diff-section">No visible changes</div>';
            }
            
            return `
                <div class="diff-section">
                    <h5>Before:</h5>
                    <div class="diff-before">${JSON.stringify(before, null, 2)}</div>
                </div>
                <div class="diff-section">
                    <h5>After:</h5>
                    <div class="diff-after">${JSON.stringify(after, null, 2)}</div>
                </div>
            `;
        }

        function handleHypothesisReady(event) {
            const payload = event.payload || {};
            const edgeIds = payload.edge_ids || [];
            
            if (edgeIds.length > 0 && cy) {
                edgeIds.forEach((edgeId, idx) => {
                    const edge = cy.getElementById(edgeId);
                    if (edge.length) {
                        setTimeout(() => {
                            edge.animate({
                                style: {
                                    'line-color': '#FF9800',
                                    'target-arrow-color': '#FF9800',
                                    'width': 6,
                                    'opacity': 1
                                }
                            }, {
                                duration: 500,
                                easing: 'ease-out'
                            });
                            setTimeout(() => {
                                edge.animate({
                                    style: {
                                        'line-color': null,
                                        'target-arrow-color': null,
                                        'width': null,
                                        'opacity': null
                                    }
                                }, {
                                    duration: 500,
                                    easing: 'ease-in'
                                });
                            }, 3000);
                        }, idx * 200);
                    }
                });
            }
        }

        function handleCandidates(event) {
            console.log('Candidates:', event.payload);
        }

        function handleEvidenceApplied(event) {
            const payload = event.payload || {};
            const edgeId = payload.highlight_edge_id || payload.edge_id;
            
            if (edgeId && cy) {
                const edge = cy.getElementById(edgeId);
                if (edge.length) {
                    edge.animate({
                        style: {
                            'line-color': '#2196F3',
                            'target-arrow-color': '#2196F3',
                            'width': 5,
                            'opacity': 1
                        }
                    }, {
                        duration: 400,
                        easing: 'ease-out'
                    });
                    setTimeout(() => {
                        edge.animate({
                            style: {
                                'line-color': null,
                                'target-arrow-color': null,
                                'width': null,
                                'opacity': null
                            }
                        }, {
                            duration: 400,
                            easing: 'ease-in'
                        });
                    }, 2500);
                }
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function toggleReasoningTrace(event) {
            // Prevent event bubbling if called from checkbox click
            if (event) {
                event.stopPropagation();
            }
            
            const checkbox = document.getElementById('trace-checkbox');
            const content = document.getElementById('reasoning-trace-content');
            
            // Toggle checkbox state
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                content.classList.add('active');
                renderReasoningTrace();
            } else {
                content.classList.remove('active');
            }
        }

        // Handle checkbox click separately
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('trace-checkbox');
            if (checkbox) {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleReasoningTrace(e);
                });
            }
        });

        function renderReasoningTrace() {
            if (!pipelineData) {
                const traceContent = document.getElementById('reasoning-trace-content');
                if (traceContent) {
                    traceContent.innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px;">No case data loaded. Please load a case first.</div>';
                }
                return;
            }
            
            const evidenceBundle = pipelineData.evidence_bundle;
            const traceContent = document.getElementById('reasoning-trace-content');
            const events = pipelineData.events || [];
            
            if (!evidenceBundle) {
                if (traceContent) {
                    traceContent.innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px;">No evidence bundle available.</div>';
                }
                return;
            }
            
            let html = '';
            
            // Show model usage if available
            const modelUsage = pipelineData.model_usage;
            if (modelUsage && modelUsage.model_mode) {
                html += '<div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px; border-left: 4px solid #2196F3;">';
                html += '<h5 style="font-size: 13px; font-weight: 700; color: #1976D2; margin-bottom: 8px;">ü§ñ Model Usage</h5>';
                html += `<div style="font-size: 12px; color: #424242;">Model calls: ${modelUsage.model_calls || 0} | Agent decisions: ${modelUsage.agent_decisions || 0}</div>`;
                html += '</div>';
            }
            
            // Show model reasoning from events
            const modelEvents = events.filter(e => e.type === 'MODEL_CALLED' && e.payload.status === 'success');
            if (modelEvents.length > 0) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">Model Reasoning:</h5>';
                modelEvents.forEach((event, idx) => {
                    const agentType = event.payload.agent_type || 'unknown';
                    const responseTime = event.payload.response_time_ms ? `${Math.round(event.payload.response_time_ms)}ms` : 'N/A';
                    const cached = event.payload.cached ? ' (cached)' : '';
                    html += `
                        <div class="evidence-item" style="border-left-color: #2196F3;">
                            <strong>${agentType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>
                            <div class="edge-id">Response time: ${responseTime}${cached}</div>
                        </div>
                    `;
                });
            }
            
            // Show agent decisions
            const agentDecisions = events.filter(e => e.type === 'AGENT_DECISION');
            if (agentDecisions.length > 0) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">Agent Decisions:</h5>';
                agentDecisions.forEach((event, idx) => {
                    const agentType = event.payload.agent_type || 'unknown';
                    const decision = event.payload.decision || 'unknown';
                    const rationale = event.payload.rationale || '';
                    const decisionColor = decision === 'use_model' ? '#4CAF50' : '#9E9E9E';
                    html += `
                        <div class="evidence-item" style="border-left-color: ${decisionColor};">
                            <strong>${agentType.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</strong>: 
                            <span style="color: ${decisionColor}; font-weight: 600;">${decision === 'use_model' ? 'Using Model' : 'Using Rules'}</span>
                            ${rationale ? `<div class="edge-id">${rationale}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // Show candidate scores if available
            if (evidenceBundle.candidate_scores && Object.keys(evidenceBundle.candidate_scores).length > 0) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">Pattern Scores:</h5>';
                const scores = Object.entries(evidenceBundle.candidate_scores)
                    .sort((a, b) => b[1] - a[1])
                    .map(([pattern, score]) => {
                        const percentage = Math.round(score * 100);
                        return `
                            <div class="evidence-item" style="border-left-color: #667eea;">
                                <strong>${pattern}</strong>: ${percentage}% confidence
                            </div>
                        `;
                    }).join('');
                html += scores;
            }
            
            // Show top discriminators
            if (evidenceBundle.top_discriminators && evidenceBundle.top_discriminators.length > 0) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">Key Evidence Items:</h5>';
                evidenceBundle.top_discriminators.forEach(item => {
                    const relation = item.relation || 'SUPPORTS';
                    const borderColor = relation === 'SUPPORTS' ? '#4CAF50' : '#f44336';
                    html += `
                        <div class="evidence-item" style="border-left-color: ${borderColor};">
                            <strong>${item.marker}</strong> (${item.marker_status}) 
                            <span style="color: ${borderColor}; font-weight: 600;">${relation}</span> 
                            ${item.pattern_id}
                            <div class="edge-id">Edge: ${item.edge_id} | Weight: ${item.weight?.toFixed(2) || 'N/A'}</div>
                        </div>
                    `;
                });
            }
            
            if (evidenceBundle.supports && evidenceBundle.supports.length > 0) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">All Supporting Evidence:</h5>';
                evidenceBundle.supports.forEach(item => {
                    html += `
                        <div class="evidence-item">
                            <strong>${item.marker}</strong> (${item.marker_status}) ‚Üí ${item.pattern_id}
                            <div class="edge-id">Edge: ${item.edge_id}</div>
                        </div>
                    `;
                });
            }
            
            if (evidenceBundle.contradictions && evidenceBundle.contradictions.length > 0) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">All Contradicting Evidence:</h5>';
                evidenceBundle.contradictions.forEach(item => {
                    html += `
                        <div class="evidence-item" style="border-left-color: #f44336;">
                            <strong>${item.marker}</strong> (${item.marker_status}) ‚Üí ${item.pattern_id}
                            <div class="edge-id">Edge: ${item.edge_id}</div>
                        </div>
                    `;
                });
            }
            
            // Show raw model output if available
            if (pipelineData.reasoner_output && pipelineData.reasoner_output.raw_model_output) {
                html += '<h5 style="margin-top: 16px; font-size: 13px; font-weight: 700; color: #495057;">Raw Model Output:</h5>';
                html += `<div class="evidence-item" style="border-left-color: #9E9E9E; font-family: monospace; font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${pipelineData.reasoner_output.raw_model_output.substring(0, 500)}${pipelineData.reasoner_output.raw_model_output.length > 500 ? '...' : ''}</div>`;
            }
            
            if (!html) {
                html = '<div style="padding: 12px; color: #6c757d; font-size: 12px;">No reasoning trace data available for this case.</div>';
            }
            
            if (traceContent) {
                traceContent.innerHTML = html;
            }
        }

        function toggleLegend() {
            const legend = document.getElementById('graph-legend');
            const content = document.getElementById('legend-content');
            const toggle = document.getElementById('legend-toggle');
            
            if (legend.classList.contains('collapsed')) {
                legend.classList.remove('collapsed');
                content.style.display = 'block';
                toggle.textContent = '‚àí';
            } else {
                legend.classList.add('collapsed');
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleAgentActivity() {
            const panel = document.getElementById('agent-activity');
            const content = document.getElementById('agent-content');
            const toggle = document.getElementById('agent-toggle');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.textContent = '‚àí';
                renderAgentActivity();
            } else {
                panel.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function renderAgentActivity() {
            if (!pipelineData || !pipelineData.events) return;
            
            const events = pipelineData.events;
            const agentDecisions = events.filter(e => e.type === 'AGENT_DECISION');
            const modelCalls = events.filter(e => e.type === 'MODEL_CALLED' && e.payload.status === 'success');
            
            const content = document.getElementById('agent-content');
            let html = '';
            
            if (agentDecisions.length === 0 && modelCalls.length === 0) {
                html = '<div style="padding: 12px; color: #6c757d; font-size: 12px; text-align: center;">No agent activity (lite mode)</div>';
            } else {
                // Group decisions by agent type
                const decisionsByAgent = {};
                agentDecisions.forEach(decision => {
                    const agentType = decision.payload.agent_type;
                    if (!decisionsByAgent[agentType]) {
                        decisionsByAgent[agentType] = [];
                    }
                    decisionsByAgent[agentType].push(decision);
                });
                
                // Show each agent's activity
                Object.keys(decisionsByAgent).forEach(agentType => {
                    const decisions = decisionsByAgent[agentType];
                    const lastDecision = decisions[decisions.length - 1];
                    const decision = lastDecision.payload.decision;
                    const rationale = lastDecision.payload.rationale || '';
                    const modelCall = modelCalls.find(m => m.payload.agent_type === agentType);
                    
                    const isModelUsed = decision === 'use_model' && modelCall;
                    const responseTime = modelCall ? `${Math.round(modelCall.payload.response_time_ms || 0)}ms` : '';
                    const cached = modelCall && modelCall.payload.cached ? ' (cached)' : '';
                    
                    html += `
                        <div class="agent-call-item ${isModelUsed ? '' : 'rule-based'}">
                            <h6>
                                <span class="agent-type">${agentType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</span>
                            </h6>
                            <div style="font-size: 11px; color: ${isModelUsed ? '#1976D2' : '#616161'}; font-weight: 600;">
                                ${isModelUsed ? 'ü§ñ Using Model' : 'üìã Using Rules'}
                            </div>
                            ${responseTime ? `<div class="agent-time">Response: ${responseTime}${cached}</div>` : ''}
                            ${rationale ? `<div class="agent-rationale">${rationale}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            content.innerHTML = html;
            
            // Show panel if there's activity
            if (agentDecisions.length > 0 || modelCalls.length > 0) {
                document.getElementById('agent-activity').style.display = 'block';
            }
        }

        /**
         * Compute conclusion highlight IDs from pipelineData: supporting edges and recommended test nodes/edges.
         * Returns { supportingEdgeIds: Set, recommendedNodeIds: Set, recommendedEdgeIds: Set }.
         */
        function getConclusionHighlightIds(data) {
            const supportingEdgeIds = new Set();
            const recommendedNodeIds = new Set();
            const recommendedEdgeIds = new Set();
            if (!data || !data.evidence_bundle) return { supportingEdgeIds, recommendedNodeIds, recommendedEdgeIds };

            const bundle = data.evidence_bundle;
            const subgraph = bundle.subgraph || { nodes: [], edges: [] };
            const reasoner = data.reasoner_output || { hypotheses: [] };

            // Supporting edge IDs: from evidence_bundle.supports and hypotheses[].evidence[].edge_id
            (bundle.supports || []).forEach(item => {
                if (item.edge_id) supportingEdgeIds.add(item.edge_id);
                (item.edge_ids || []).forEach(id => supportingEdgeIds.add(id));
            });
            (reasoner.hypotheses || []).forEach(h => {
                (h.evidence || []).forEach(ev => {
                    if (ev.edge_id) supportingEdgeIds.add(ev.edge_id);
                });
            });

            // Recommended test node IDs: from hypotheses[].next_tests (string or { test_id, label })
            const testNodes = (subgraph.nodes || []).filter(n => n.type === 'Test');
            (reasoner.hypotheses || []).forEach(h => {
                (h.next_tests || []).forEach(t => {
                    let id = null;
                    if (typeof t === 'object' && t !== null && t.test_id) id = t.test_id;
                    else if (typeof t === 'string') {
                        const lower = t.toLowerCase();
                        const match = testNodes.find(n =>
                            n.id === t || n.id === 't_' + lower.replace(/\s+/g, '_') ||
                            (n.label && n.label.toLowerCase().includes(lower))
                        );
                        id = match ? match.id : null;
                    }
                    if (id) recommendedNodeIds.add(id);
                });
            });

            // Recommended edge IDs: RECOMMENDS_TEST edges whose target (or source) is a recommended test node
            (subgraph.edges || []).forEach(edge => {
                if (edge.relation === 'RECOMMENDS_TEST' &&
                    (recommendedNodeIds.has(edge.to) || recommendedNodeIds.has(edge.from))) {
                    recommendedEdgeIds.add(edge.id);
                }
            });

            return { supportingEdgeIds, recommendedNodeIds, recommendedEdgeIds };
        }

        // Keep final state clear after animation completes; apply conclusion highlights (supporting edges, recommended tests)
        function finalizeGraphState() {
            if (!cy) return;
            
            // Remove step animation classes and previous conclusion classes
            cy.nodes().removeClass('highlighted pulsing conclusion-support conclusion-recommended');
            cy.edges().removeClass('highlighted flowing conclusion-support conclusion-recommended');
            
            // Reset nodes/edges to default visibility
            cy.nodes().forEach(node => {
                const type = node.data('type');
                if (type) {
                    node.style({
                        'opacity': 1,
                        'background-opacity': 0.95
                    });
                }
            });
            cy.edges().forEach(edge => {
                const relation = edge.data('relation');
                if (relation) {
                    edge.style({
                        'opacity': 0.7
                    });
                }
            });

            // Apply conclusion highlights from pipelineData
            const ids = getConclusionHighlightIds(pipelineData);
            ids.supportingEdgeIds.forEach(edgeId => {
                const edge = cy.getElementById(edgeId);
                if (edge.length) edge.addClass('conclusion-support');
            });
            ids.recommendedNodeIds.forEach(nodeId => {
                const node = cy.getElementById(nodeId);
                if (node.length) node.addClass('conclusion-recommended');
            });
            ids.recommendedEdgeIds.forEach(edgeId => {
                const edge = cy.getElementById(edgeId);
                if (edge.length) edge.addClass('conclusion-recommended');
            });
        }

        window.onload = init;
    </script>
</body>
</html>
