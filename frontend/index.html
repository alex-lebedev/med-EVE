<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>med-EVE — Clinical Decision Support</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/cytoscape@3.23.0/dist/cytoscape.min.js"></script>
    <style>
        :root {
            --c-primary: #1a73e8;
            --c-primary-dark: #1557b0;
            --c-primary-light: #e8f0fe;
            --c-surface: #ffffff;
            --c-bg: #f1f3f4;
            --c-border: #dadce0;
            --c-border-light: #e8eaed;
            --c-text: #202124;
            --c-text-sec: #5f6368;
            --c-text-ter: #80868b;
            --c-success: #137333;
            --c-success-bg: #e6f4ea;
            --c-warning: #ea8600;
            --c-warning-bg: #fef7e0;
            --c-error: #c5221f;
            --c-error-bg: #fce8e6;
            --c-teal: #0d652d;
            --shadow-xs: 0 1px 2px rgba(60,64,67,.1);
            --shadow-sm: 0 1px 3px rgba(60,64,67,.12), 0 1px 2px rgba(60,64,67,.08);
            --shadow-md: 0 2px 6px rgba(60,64,67,.15), 0 1px 4px rgba(60,64,67,.08);
            --shadow-lg: 0 4px 12px rgba(60,64,67,.15), 0 2px 6px rgba(60,64,67,.08);
            --r-sm: 4px;
            --r-md: 8px;
            --r-lg: 12px;
            --r-pill: 100px;
            --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font);
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--c-bg);
            color: var(--c-text);
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header */
        #header {
            background: var(--c-surface);
            color: var(--c-text);
            padding: 0 24px;
            height: 56px;
            display: flex;
            align-items: center;
            gap: 16px;
            border-bottom: 1px solid var(--c-border);
            box-shadow: var(--shadow-xs);
            z-index: 10;
        }

        #header h1 {
            font-size: 16px;
            font-weight: 600;
            margin-right: auto;
            letter-spacing: -0.2px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--c-text);
        }

        #demo-mode-btn {
            background: var(--c-primary);
            color: #fff;
            border: none;
            padding: 7px 16px;
            border-radius: var(--r-sm);
            cursor: pointer;
            font-family: var(--font);
            font-weight: 500;
            font-size: 13px;
            transition: background .15s, box-shadow .15s;
        }

        #demo-mode-btn:hover {
            background: var(--c-primary-dark);
            box-shadow: var(--shadow-sm);
        }

        #case-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #case-selector label {
            font-size: 13px;
            font-weight: 500;
            color: var(--c-text-sec);
        }

        #case-selector select {
            padding: 6px 10px;
            border: 1px solid var(--c-border);
            background: var(--c-surface);
            color: var(--c-text);
            border-radius: var(--r-sm);
            font-size: 13px;
            font-family: var(--font);
            outline: none;
            transition: border-color .15s;
        }

        #case-selector select:focus {
            border-color: var(--c-primary);
        }

        #case-selector button {
            padding: 6px 14px;
            border: 1px solid var(--c-border);
            background: var(--c-surface);
            color: var(--c-text);
            border-radius: var(--r-sm);
            font-size: 13px;
            font-family: var(--font);
            font-weight: 500;
            cursor: pointer;
            transition: background .15s, border-color .15s;
        }

        #case-selector button:hover {
            background: var(--c-bg);
            border-color: var(--c-primary);
        }

        #case-selector select option {
            background: var(--c-surface);
            color: var(--c-text);
        }

        /* Model Status Indicator */
        #model-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            border-radius: var(--r-pill);
            font-size: 12px;
            font-weight: 500;
            background: var(--c-bg);
            border: 1px solid var(--c-border);
            color: var(--c-text-sec);
            transition: all .2s;
        }

        #model-status.active {
            background: var(--c-success-bg);
            border-color: #a8dab5;
            color: var(--c-success);
        }

        #model-status.lite {
            background: var(--c-bg);
            border-color: var(--c-border);
            color: var(--c-text-ter);
        }

        #model-status .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--c-success);
        }

        #model-status.lite .status-dot {
            background: var(--c-text-ter);
        }

        #model-status.loading {
            background: var(--c-warning-bg);
            border-color: #f5deb3;
            color: var(--c-warning);
        }

        #model-status.loading .status-dot {
            background: var(--c-warning);
            animation: model-status-pulse 1.2s ease-in-out infinite;
        }

        @keyframes model-status-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.15); }
        }

        /* Timeline */
        #timeline {
            background: var(--c-surface);
            border-bottom: 1px solid var(--c-border);
            padding: 10px 24px;
            display: flex;
            align-items: center;
            gap: 6px;
            overflow-x: auto;
            min-height: 56px;
        }

        .step-chip {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: var(--r-pill);
            background: var(--c-bg);
            color: var(--c-text-sec);
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            transition: all .25s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            border: 1px solid transparent;
        }

        .step-chip::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .step-chip.active::before {
            left: 100%;
        }

        .step-chip.active {
            background: var(--c-primary);
            color: #fff;
            border-color: var(--c-primary);
            box-shadow: 0 1px 4px rgba(26,115,232,.3);
        }

        .step-chip.completed {
            background: var(--c-success-bg);
            color: var(--c-success);
            border-color: #a8dab5;
        }

        .step-duration {
            font-size: 10px;
            opacity: 0.8;
            margin-left: 2px;
            font-weight: 400;
            font-family: var(--mono);
        }

        /* Playback controls */
        #playback-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-left: auto;
            padding-left: 16px;
            border-left: 1px solid var(--c-border);
        }

        #playback-controls button {
            padding: 6px 12px;
            border: 1px solid var(--c-border);
            background: var(--c-surface);
            border-radius: var(--r-sm);
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font);
            color: var(--c-text-sec);
            transition: all .15s;
        }

        #playback-controls button:hover {
            background: var(--c-bg);
            border-color: var(--c-primary);
            color: var(--c-primary);
        }

        #playback-controls button.active {
            background: var(--c-primary);
            color: #fff;
            border-color: var(--c-primary);
        }

        /* Main layout */
        #main {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Left panel */
        #left {
            width: 300px;
            background: var(--c-surface);
            border-right: 1px solid var(--c-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        #left h3 {
            padding: 14px 20px;
            border-bottom: 1px solid var(--c-border);
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .5px;
            color: var(--c-text-sec);
            background: var(--c-surface);
        }

        #abnormal-labs {
            padding: 12px 16px;
        }

        .lab-item {
            padding: 12px 14px;
            margin-bottom: 8px;
            border-radius: var(--r-md);
            border-left: 3px solid var(--c-border);
            background: var(--c-surface);
            transition: all .25s ease;
            box-shadow: var(--shadow-xs);
        }

        .lab-item.HIGH {
            border-left-color: var(--c-error);
            background: var(--c-error-bg);
        }

        .lab-item.LOW {
            border-left-color: var(--c-primary);
            background: var(--c-primary-light);
        }

        .lab-item.unknown {
            border-left-color: var(--c-text-ter);
            background: var(--c-bg);
        }

        .lab-item.pulse {
            animation: pulseGlow 1.5s ease-in-out infinite;
            box-shadow: 0 0 0 0 rgba(26,115,232,.5);
        }

        @keyframes pulseGlow {
            0% { box-shadow: 0 0 0 0 rgba(26,115,232,.5); }
            50% { box-shadow: 0 0 0 6px rgba(26,115,232,.15); }
            100% { box-shadow: 0 0 0 0 rgba(26,115,232,0); }
        }

        .lab-item .marker-name {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--c-text);
        }

        .lab-item .lab-value {
            font-size: 12px;
            color: var(--c-text-sec);
            font-family: var(--mono);
            font-weight: 400;
        }

        /* Center - Graph */
        #center {
            flex: 1;
            position: relative;
            background: var(--c-bg);
            overflow: hidden;
        }

        #cy {
            width: 100%;
            height: 100%;
        }

        /* Legend */
        #graph-legend {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--c-surface);
            border-radius: var(--r-lg);
            padding: 14px 16px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            min-width: 200px;
            border: 1px solid var(--c-border);
            transition: opacity 0.2s;
        }

        #graph-legend.collapsed {
            opacity: 0.4;
        }

        #graph-legend.collapsed:hover {
            opacity: 1;
        }

        #graph-legend h4 {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--c-text-sec);
            text-transform: uppercase;
            letter-spacing: .5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #graph-legend-toggle {
            cursor: pointer;
            font-size: 12px;
            color: var(--c-primary);
            font-weight: 500;
        }

        .legend-section {
            margin-bottom: 10px;
        }

        .legend-section:last-child {
            margin-bottom: 0;
        }

        .legend-section h5 {
            font-size: 10px;
            font-weight: 600;
            color: var(--c-text-ter);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: .5px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 11px;
            color: var(--c-text-sec);
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-node {
            width: 20px;
            height: 20px;
            border-radius: var(--r-sm);
            border: 2px solid;
            flex-shrink: 0;
        }

        .legend-node.marker {
            background-color: #a8c7fa;
            border-color: #1a73e8;
        }

        .legend-node.pattern {
            background-color: #a8dab5;
            border-color: #137333;
        }

        .legend-node.condition {
            background-color: #fdd663;
            border-color: #ea8600;
        }

        .legend-node.test {
            background-color: #d7aefb;
            border-color: #7b1fa2;
        }

        .legend-edge {
            width: 32px;
            height: 2px;
            flex-shrink: 0;
            position: relative;
        }

        .legend-edge::after {
            content: '';
            position: absolute;
            right: -5px;
            top: -3px;
            width: 0;
            height: 0;
            border-left: 5px solid;
            border-top: 4px solid transparent;
            border-bottom: 4px solid transparent;
        }

        .legend-edge.supports {
            background-color: #137333;
        }

        .legend-edge.supports::after {
            border-left-color: #137333;
        }

        .legend-edge.contradicts {
            background-color: #c5221f;
        }

        .legend-edge.contradicts::after {
            border-left-color: #c5221f;
        }

        .legend-edge.recommends {
            background-color: #ea8600;
            border-style: dashed;
        }

        .legend-edge.recommends::after {
            border-left-color: #ea8600;
        }

        .legend-edge.causal {
            background-color: #1a73e8;
        }

        .legend-edge.causal::after {
            border-left-color: #1a73e8;
        }

        /* Agent Activity Panel */
        #agent-activity {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: var(--c-surface);
            border-radius: var(--r-lg);
            padding: 14px 16px;
            box-shadow: var(--shadow-md);
            z-index: 100;
            min-width: 260px;
            max-width: 380px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--c-border);
        }

        #agent-activity h4 {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--c-text-sec);
            text-transform: uppercase;
            letter-spacing: .5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        #agent-content {
            font-size: 12px;
        }

        .agent-call-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: var(--c-primary-light);
            border-radius: var(--r-md);
            border-left: 3px solid var(--c-primary);
        }

        .agent-call-item.rule-based {
            background: var(--c-bg);
            border-left-color: var(--c-text-ter);
        }

        .agent-call-item h6 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 3px;
            color: var(--c-primary-dark);
        }

        .agent-call-item.rule-based h6 {
            color: var(--c-text-sec);
        }

        .agent-call-item .agent-type {
            font-weight: 600;
            text-transform: capitalize;
        }

        .agent-call-item .agent-time {
            font-size: 11px;
            color: var(--c-text-ter);
            margin-top: 3px;
            font-family: var(--mono);
        }

        .agent-call-item .agent-rationale {
            font-size: 11px;
            color: var(--c-text-sec);
            margin-top: 3px;
            font-style: italic;
        }

        /* Graph animation styles */
        .node-highlight {
            animation: nodePulse 1.5s ease-in-out infinite;
        }

        @keyframes nodePulse {
            0%, 100% { 
                transform: scale(1);
                filter: drop-shadow(0 0 6px rgba(26,115,232,.6));
            }
            50% { 
                transform: scale(1.1);
                filter: drop-shadow(0 0 14px rgba(26,115,232,.8));
            }
        }

        .edge-highlight {
            animation: edgeFlow 2s ease-in-out infinite;
        }

        @keyframes edgeFlow {
            0%   { opacity: 0.6; stroke-width: 3px; }
            50%  { opacity: 1;   stroke-width: 5px; }
            100% { opacity: 0.6; stroke-width: 3px; }
        }

        /* Right panel */
        #right {
            width: 380px;
            background: var(--c-surface);
            border-left: 1px solid var(--c-border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .case-overview-card {
            background: var(--c-primary-light);
            border: 1px solid #c5d9f7;
            border-radius: var(--r-md);
            padding: 12px 14px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--c-text);
        }

        .tab-buttons {
            display: flex;
            border-bottom: 1px solid var(--c-border);
            background: var(--c-surface);
        }

        .tab-button {
            flex: 1;
            padding: 11px 8px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            font-family: var(--font);
            color: var(--c-text-sec);
            transition: all .2s;
            position: relative;
        }

        .tab-button::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--c-primary);
            transition: width .2s;
        }

        .tab-button.active {
            color: var(--c-primary);
            font-weight: 600;
        }

        .tab-button.active::after {
            width: 100%;
        }

        .tab-button:hover {
            color: var(--c-primary);
            background: var(--c-primary-light);
        }

        .tab-content {
            display: none;
            padding: 16px 20px;
            animation: fadeIn .2s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        .tab-content h3 {
            font-size: 13px;
            font-weight: 600;
            color: var(--c-text-sec);
            text-transform: uppercase;
            letter-spacing: .3px;
            margin-bottom: 12px;
        }

        /* Hypothesis card */
        .hypothesis-card {
            background: var(--c-surface);
            border-radius: var(--r-md);
            padding: 16px;
            margin-bottom: 12px;
            border: 1px solid var(--c-border);
            transition: box-shadow .2s, border-color .2s;
        }

        .hypothesis-card:hover {
            box-shadow: var(--shadow-sm);
            border-color: #c5d9f7;
        }

        .hypothesis-card h4 {
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--c-text);
        }

        .hypothesis-card .confidence {
            display: inline-block;
            padding: 4px 10px;
            background: var(--c-success);
            color: #fff;
            border-radius: var(--r-pill);
            font-size: 12px;
            font-weight: 600;
            font-family: var(--mono);
        }

        .hypothesis-card .confidence.high-confidence {
            background: var(--c-success);
        }

        .hypothesis-card .confidence.medium-confidence {
            background: var(--c-warning);
        }

        .hypothesis-card .confidence.low-confidence {
            background: var(--c-text-ter);
        }

        .hypothesis-card .next-tests {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--c-border-light);
        }

        .hypothesis-card .next-tests h5 {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--c-text-sec);
        }

        .hypothesis-card .next-tests ul {
            list-style: none;
            font-size: 12px;
            color: var(--c-text-sec);
        }

        .hypothesis-card .next-tests li {
            padding: 4px 0;
            padding-left: 18px;
            position: relative;
        }

        .hypothesis-card .next-tests li::before {
            content: '\2192';
            position: absolute;
            left: 0;
            color: var(--c-primary);
            font-weight: 600;
        }

        /* Patient action card */
        .action-card {
            background: var(--c-surface);
            border-radius: var(--r-md);
            padding: 12px 14px;
            margin-bottom: 8px;
            border-left: 3px solid var(--c-primary);
            transition: box-shadow .2s;
            border: 1px solid var(--c-border-light);
            border-left: 3px solid var(--c-primary);
        }

        .action-card:hover {
            box-shadow: var(--shadow-sm);
        }

        .action-card .task {
            font-weight: 600;
            font-size: 13px;
            margin-bottom: 4px;
            color: var(--c-text);
        }

        .action-card .why {
            font-size: 12px;
            color: var(--c-text-sec);
            margin-bottom: 6px;
            line-height: 1.5;
        }

        .action-card .risk {
            display: inline-block;
            margin-top: 6px;
            padding: 2px 8px;
            border-radius: var(--r-pill);
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .3px;
        }

        .action-card .risk.low {
            background: var(--c-success-bg);
            color: var(--c-success);
        }

        .action-card .risk.medium {
            background: var(--c-warning-bg);
            color: var(--c-warning);
        }

        .action-card .risk.high {
            background: var(--c-error-bg);
            color: var(--c-error);
        }

        /* Reasoning trace */
        #reasoning-trace {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--c-border);
        }

        #reasoning-trace-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            cursor: pointer;
            user-select: none;
            padding: 6px 8px;
            border-radius: var(--r-sm);
            transition: background .15s;
            font-size: 13px;
            color: var(--c-text-sec);
        }

        #reasoning-trace-toggle:hover {
            background: var(--c-bg);
        }

        #reasoning-trace-toggle input {
            cursor: pointer;
            width: 16px;
            height: 16px;
            accent-color: var(--c-primary);
        }

        #reasoning-trace-content {
            display: none;
            max-height: 400px;
            overflow-y: auto;
        }

        #reasoning-trace-content.active {
            display: block;
            animation: fadeIn .2s;
        }

        .evidence-item {
            padding: 10px 12px;
            margin-bottom: 6px;
            background: var(--c-bg);
            border-radius: var(--r-md);
            font-size: 12px;
            border-left: 3px solid var(--c-success);
            transition: box-shadow .15s;
        }

        .evidence-item:hover {
            box-shadow: var(--shadow-xs);
        }

        .evidence-item .edge-id {
            font-family: var(--mono);
            color: var(--c-text-ter);
            font-size: 10px;
            margin-top: 3px;
        }

        /* Trust Moments */
        #trust-moments {
            position: fixed;
            top: 70px;
            right: 16px;
            width: 400px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .trust-moment {
            background: var(--c-surface);
            border-radius: var(--r-lg);
            padding: 16px;
            box-shadow: var(--shadow-lg);
            animation: slideInRight .3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid var(--c-border);
        }

        @keyframes slideInRight {
            from { transform: translateX(110%); opacity: 0; }
            to   { transform: translateX(0);    opacity: 1; }
        }

        .guardrail-fail {
            border-left: 4px solid var(--c-error);
            background: var(--c-error-bg);
            border-color: var(--c-error);
        }

        .guardrail-fail h4 {
            color: var(--c-error);
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .guardrail-fail .rule-id {
            font-family: var(--mono);
            font-size: 11px;
            color: var(--c-text-sec);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .guardrail-fail .message {
            font-size: 13px;
            color: var(--c-text);
            line-height: 1.5;
        }

        .patch-diff {
            border-left: 4px solid var(--c-warning);
            background: var(--c-warning-bg);
            border-color: var(--c-warning);
        }

        .patch-diff h4 {
            color: #b06000;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .trust-pill {
            display: inline-block;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: .05em;
            text-transform: uppercase;
            padding: 3px 8px;
            border-radius: var(--r-pill);
            margin-bottom: 8px;
        }

        .trust-pill-danger {
            background: var(--c-error);
            color: #fff;
        }

        .trust-pill-warn {
            background: var(--c-warning);
            color: #fff;
        }

        .diff-section {
            margin-bottom: 12px;
        }

        .diff-section h5 {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--c-text-sec);
            text-transform: uppercase;
            letter-spacing: .3px;
        }

        .diff-before, .diff-after {
            padding: 8px 10px;
            border-radius: var(--r-sm);
            font-size: 11px;
            font-family: var(--mono);
            white-space: pre-wrap;
            word-break: break-all;
            line-height: 1.5;
        }

        .diff-before {
            background: var(--c-error-bg);
            color: var(--c-error);
            margin-bottom: 4px;
            border: 1px solid #f5c6c4;
        }

        .diff-after {
            background: var(--c-success-bg);
            color: var(--c-success);
            border: 1px solid #a8dab5;
        }

        /* MedGemma reasoning indicator */
        #reasoning-banner {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 24px;
            background: var(--c-primary-light);
            border-bottom: 1px solid #c5d9f7;
            font-size: 13px;
            font-weight: 500;
            color: var(--c-primary-dark);
        }
        #reasoning-banner.visible {
            display: flex;
        }
        #reasoning-banner .reasoning-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(26,115,232,.25);
            border-top-color: var(--c-primary);
            border-radius: 50%;
            animation: reasoning-spin .7s linear infinite;
        }
        @keyframes reasoning-spin {
            to { transform: rotate(360deg); }
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Utility classes for JS-generated content */
        .panel-section {
            padding: 12px 20px;
            background: var(--c-surface);
            border-bottom: 1px solid var(--c-border-light);
        }
        .panel-section-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--c-text-sec);
        }
        .panel-hint {
            font-size: 11px;
            color: var(--c-text-ter);
        }
        .btn-primary {
            padding: 7px 16px;
            background: var(--c-primary);
            color: #fff;
            border: none;
            border-radius: var(--r-sm);
            cursor: pointer;
            font-family: var(--font);
            font-weight: 500;
            font-size: 13px;
            transition: background .15s;
        }
        .btn-primary:hover { background: var(--c-primary-dark); }
        .btn-secondary {
            padding: 7px 14px;
            background: var(--c-surface);
            color: var(--c-text);
            border: 1px solid var(--c-border);
            border-radius: var(--r-sm);
            cursor: pointer;
            font-family: var(--font);
            font-weight: 500;
            font-size: 13px;
            transition: background .15s, border-color .15s;
        }
        .btn-secondary:hover { background: var(--c-bg); border-color: var(--c-primary); }
        .input-field {
            padding: 8px 12px;
            border: 1px solid var(--c-border);
            border-radius: var(--r-sm);
            font-size: 13px;
            font-family: var(--font);
            color: var(--c-text);
            resize: vertical;
            outline: none;
            transition: border-color .15s;
            width: 100%;
        }
        .input-field:focus { border-color: var(--c-primary); }
        .status-bar {
            padding: 6px 24px;
            background: var(--c-bg);
            border-bottom: 1px solid var(--c-border-light);
            font-size: 11px;
            color: var(--c-text-ter);
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            font-family: var(--mono);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div id="header">
        <h1><img src="logo.svg" alt="med-EVE" width="32" height="32" style="border-radius:8px; vertical-align:middle;"> med-EVE</h1>
        <div id="model-status" class="lite" title="Click to check model status">
            <span class="status-dot"></span>
            <span id="model-status-text">Lite Mode</span>
        </div>
        <button id="demo-mode-btn" onclick="runDemoMode()">Demo</button>
        <div id="case-selector">
            <label for="case-select">Case</label>
            <select id="case-select"></select>
            <button onclick="loadSelectedCase()">Load</button>
        </div>
    </div>

    <!-- Unified clinical input panel -->
    <div id="analyze-panel" class="panel-section">
        <div style="display: flex; gap: 8px; align-items: flex-start;">
            <textarea id="analyze-text" class="input-field" placeholder="Lab values: Ferritin 12 ng/mL, Hb 10.5 g/dL  |  Question: Why is iron deficiency the top hypothesis?" rows="2" style="flex: 1; min-width: 200px;"></textarea>
        </div>
        <div style="display: flex; gap: 6px; margin-top: 8px; align-items: center; flex-wrap: wrap;">
            <button id="analyze-btn" onclick="runFromTextNew()" class="btn-primary" title="Parse lab values and run a fresh analysis">Analyze New</button>
            <button id="merge-btn" onclick="runFromTextMerge()" class="btn-secondary" disabled title="Add lab values to the current case and re-analyze">Add to Case</button>
            <div style="width: 1px; height: 20px; background: var(--c-border); margin: 0 2px;"></div>
            <button id="ask-btn" onclick="askAboutCase()" class="btn-secondary" disabled title="Ask a question about the current case (e.g. Explain why...)">Ask Question</button>
            <span id="analyze-merge-hint" class="panel-hint" style="margin-left: auto;"></span>
        </div>
        <!-- Hidden elements to preserve JS compatibility -->
        <input type="radio" name="analyze-mode" value="new" id="analyze-mode-new" checked style="display:none;">
        <input type="radio" name="analyze-mode" value="merge" id="analyze-mode-merge" style="display:none;">
        <span id="session-id-label" style="display:none;">none</span>
    </div>

    <!-- Run status -->
    <div id="run-status" class="status-bar">
        <span>Case: <span id="current-case-label">none</span></span>
        <span>Output: <span id="output-path-label">—</span></span>
        <button type="button" id="clear-current-case-btn" onclick="clearCurrentCase()" class="btn-secondary" style="margin-left: auto; padding: 2px 8px; font-size: 10px;">Clear</button>
    </div>

    <!-- MedGemma reasoning indicator (shown during model ranking/reasoning/impression, hidden when final) -->
    <div id="reasoning-banner" aria-live="polite">
        <span class="reasoning-spinner"></span>
        <span id="reasoning-banner-label">MedGemma is reasoning…</span>
    </div>

    <!-- Timeline -->
    <div id="timeline">
        <div class="step-chip" data-step="LAB_NORMALIZE">
            <span>Lab Normalize</span>
            <span class="step-duration" id="duration-LAB_NORMALIZE"></span>
        </div>
        <div class="step-chip" data-step="CONTEXT_SELECT">
            <span>Context Select</span>
            <span class="step-duration" id="duration-CONTEXT_SELECT"></span>
        </div>
        <div class="step-chip" data-step="EVIDENCE_SCORE">
            <span>Evidence Score</span>
            <span class="step-duration" id="duration-EVIDENCE_SCORE"></span>
        </div>
        <div class="step-chip" data-step="REASON">
            <span>Reason</span>
            <span class="step-duration" id="duration-REASON"></span>
        </div>
        <div class="step-chip" data-step="CRITIC">
            <span>Critic</span>
            <span class="step-duration" id="duration-CRITIC"></span>
        </div>
        <div class="step-chip" data-step="GUARDRAILS">
            <span>Guardrails</span>
            <span class="step-duration" id="duration-GUARDRAILS"></span>
        </div>
        <div class="step-chip" data-step="FINAL">
            <span>Final</span>
            <span class="step-duration" id="duration-FINAL"></span>
        </div>
        <div id="playback-controls">
            <button id="play-pause-btn" onclick="togglePlayPause()">▶ Play</button>
            <button onclick="replay()">↻ Replay</button>
            <button onclick="jumpToEnd()">⏭ Jump to End</button>
        </div>
    </div>

    <!-- Main layout -->
    <div id="main">
        <!-- Left: Abnormal labs -->
        <div id="left">
            <h3>Abnormal Markers</h3>
            <div id="abnormal-labs"></div>
        </div>

        <!-- Center: Graph -->
        <div id="center">
            <div id="cy"></div>
            <!-- Legend -->
            <div id="graph-legend">
                <h4>
                    <span>Graph Legend</span>
                    <span id="legend-toggle" class="legend-toggle" onclick="toggleLegend()">−</span>
                </h4>
                <div id="legend-content">
                    <div class="legend-section">
                        <h5>Node Types</h5>
                        <div class="legend-item">
                            <div class="legend-node marker"></div>
                            <span>Marker (Lab Value)</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-node pattern"></div>
                            <span>Pattern</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-node condition"></div>
                            <span>Condition</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-node test"></div>
                            <span>Test</span>
                        </div>
                    </div>
                    <div class="legend-section">
                        <h5>Edge Types</h5>
                        <div class="legend-item">
                            <div class="legend-edge supports"></div>
                            <span>Supports</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-edge contradicts"></div>
                            <span>Contradicts</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-edge recommends"></div>
                            <span>Recommends Test</span>
                        </div>
                        <div class="legend-item">
                            <div class="legend-edge causal"></div>
                            <span>Causal (Increases/Decreases)</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Agent Activity Panel -->
            <div id="agent-activity" style="display: none;">
                <h4>
                    <span>Agent Activity</span>
                    <span id="agent-toggle" onclick="toggleAgentActivity()" style="cursor: pointer; color: var(--c-primary);">−</span>
                </h4>
                <div id="agent-content"></div>
            </div>
        </div>

        <!-- Right: Tabs -->
        <div id="right">
            <div id="case-overview-wrap" style="display: none; padding: 16px 20px 0;">
                <div style="font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: .5px; color: var(--c-text-sec); margin-bottom: 8px;">Case Overview</div>
                <div id="case-overview" class="case-overview-card"></div>
            </div>
            <div id="unlinked-markers-wrap" style="display: none; padding: 8px 20px 0;">
                <div id="unlinked-markers-note" class="case-overview-card" style="border-color: #f5deb3; background: var(--c-warning-bg);"></div>
            </div>
            <div id="unmappable-inputs-wrap" style="display: none; padding: 8px 20px 0;">
                <div id="unmappable-inputs-note" class="case-overview-card" style="border-color: #f5c6c4; background: var(--c-error-bg);"></div>
            </div>
            <div class="tab-buttons">
                <button class="tab-button active" onclick="showTab('clinician')">Clinician</button>
                <button class="tab-button" onclick="showTab('patient')">Patient</button>
                <button class="tab-button" onclick="showTab('guidance')">Guidance</button>
                <button class="tab-button" onclick="showTab('explanation')">Explanation</button>
                <button class="tab-button" onclick="showTab('next-steps')">Next Steps</button>
            </div>
            <div id="clinician" class="tab-content active">
                <h3>Hypotheses</h3>
                <div id="hypotheses"></div>
                <h3 style="margin-top: 16px;">Novel Insights</h3>
                <div id="novel-insights"></div>
                <div id="reasoning-trace">
                    <div id="reasoning-trace-toggle">
                        <input type="checkbox" id="trace-checkbox" onclick="toggleReasoningTrace(event)">
                        <label for="trace-checkbox" onclick="toggleReasoningTrace(event)">Show Reasoning Trace</label>
                    </div>
                    <div id="reasoning-trace-content"></div>
                </div>
            </div>
            <div id="patient" class="tab-content">
                <h3>Patient Actions</h3>
                <div id="actions"></div>
                <h3 style="margin-top: 16px;">Novel Actions</h3>
                <div id="novel-actions"></div>
            </div>
            <div id="guidance" class="tab-content">
                <h3>Step-by-Step Guidance</h3>
                <div id="guidance-content">
                    <div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">
                        Load a case to see step-by-step guidance
                    </div>
                </div>
            </div>
            <div id="explanation" class="tab-content">
                <h3>Explanation</h3>
                <div id="explanation-content">
                    <div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">
                        Ask a follow-up question to see an explanation
                    </div>
                </div>
            </div>
            <div id="next-steps" class="tab-content">
                <h3>Recommended Next Steps</h3>
                <div id="next-steps-content">
                    <div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">
                        Load a case to see recommended next steps
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Trust Moments -->
    <div id="trust-moments"></div>

    <script>
        let cy;
        let events = [];
        let currentEventIndex = 0;
        let isPlaying = false;
        let playInterval = null;
        let pipelineData = null;
        let stepDurations = {};
        let highlightedNodes = new Set();
        let highlightedEdges = new Set();
        let animationTimeouts = [];
        let sessionId = null;

        const API_BASE = 'http://localhost:8000';
        let modelHealth = null;
        let lastCurrentCaseId = null;
        let currentLoadId = 0;

        function safeLower(v) {
            if (v == null) return '';
            return (typeof v === 'string') ? v.toLowerCase() : '';
        }

        function updateCurrentCaseDisplay(caseId) {
            lastCurrentCaseId = caseId || null;
            const el = document.getElementById('current-case-label');
            if (el) el.textContent = caseId || 'none';
            updateAnalyzeMergeState();
        }

        function updateOutputPathDisplay(path) {
            const el = document.getElementById('output-path-label');
            if (el) el.textContent = path || '—';
        }

        function updateAnalyzeMergeState() {
            const mergeRadio = document.getElementById('analyze-mode-merge');
            const hint = document.getElementById('analyze-merge-hint');
            const mergeBtn = document.getElementById('merge-btn');
            const askBtn = document.getElementById('ask-btn');
            if (!hint) return;
            if (lastCurrentCaseId) {
                if (mergeRadio) mergeRadio.disabled = false;
                if (mergeBtn) mergeBtn.disabled = false;
                if (askBtn) askBtn.disabled = false;
                hint.textContent = 'Active: ' + lastCurrentCaseId;
            } else {
                if (mergeRadio) {
                    mergeRadio.disabled = true;
                    if (mergeRadio.checked) {
                        document.getElementById('analyze-mode-new').checked = true;
                    }
                }
                if (mergeBtn) mergeBtn.disabled = true;
                if (askBtn) askBtn.disabled = true;
                hint.textContent = '';
            }
        }

        function runFromTextNew() {
            document.getElementById('analyze-mode-new').checked = true;
            runFromText(true);
        }

        function runFromTextMerge() {
            document.getElementById('analyze-mode-merge').checked = true;
            runFromText(true);
        }

        async function askAboutCase() {
            const textarea = document.getElementById('analyze-text');
            const text = (textarea && textarea.value) ? textarea.value.trim() : '';
            if (!text) return;

            if (!pipelineData || !pipelineData.normalized_labs || pipelineData.normalized_labs.length === 0) {
                alert('Load or analyze a case first, then ask a question about it.');
                return;
            }

            const askBtn = document.getElementById('ask-btn');
            const explEl = document.getElementById('explanation-content');

            // Show loading state immediately
            if (askBtn) { askBtn.disabled = true; askBtn.textContent = 'Thinking…'; }
            showTab('explanation');
            if (explEl) explEl.innerHTML = `<div style="padding: 24px; text-align: center; color: var(--c-muted);">
                <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid var(--c-border); border-top-color: var(--c-primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 8px;"></div>
                <div style="font-size: 13px;">Processing your question…</div>
            </div>`;

            try {
                // Auto-start session if needed
                if (!sessionId) {
                    const labs = pipelineData.normalized_labs;
                    const labText = labs.map(l => `${l.marker} ${l.value} ${(l.unit || '').trim()}`).join(', ');
                    const startRes = await fetch(`${API_BASE}/session/start`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: labText })
                    });
                    if (!startRes.ok) {
                        const err = await startRes.json().catch(() => ({}));
                        throw new Error(err.detail || 'Failed to initialize session');
                    }
                    const startData = await startRes.json();
                    updateSessionLabel(startData.session_id);
                }

                // Send the question
                const res = await fetch(`${API_BASE}/session/${sessionId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, intent: 'explanation' })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || res.statusText);
                }
                const data = await res.json();
                if (data.turn_type === 'explanation') {
                    if (explEl) explEl.innerHTML = `<div style="padding: 16px; font-size: 13px; line-height: 1.7;">
                        <div style="font-size: 11px; color: var(--c-muted); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;">Q: ${text}</div>
                        <div>${data.explanation || 'No explanation available.'}</div>
                    </div>`;
                } else if (data.turn_type === 'update') {
                    const output = data.output || {};
                    pipelineData = output;
                    events = output.events || [];
                    renderInitial(output);
                    updateCurrentCaseDisplay(output.current_case_id ?? output.case_id);
                    updateOutputPathDisplay(output.output_path ?? null);
                    if (explEl) explEl.innerHTML = `<div style="padding: 16px; font-size: 13px; color: var(--c-muted); text-align: center;">Case updated with new clinical info. See results in the Clinician tab.</div>`;
                } else {
                    if (explEl) explEl.innerHTML = `<div style="padding: 16px; font-size: 13px; color: var(--c-muted); text-align: center;">${data.message || 'No response. Try a specific question like "Why is iron deficiency the top hypothesis?"'}</div>`;
                }
            } catch (e) {
                console.error('Ask failed:', e);
                if (explEl) explEl.innerHTML = `<div style="padding: 16px; font-size: 13px; color: #c62828; text-align: center;">Error: ${e.message || 'Request failed'}</div>`;
            } finally {
                if (askBtn) { askBtn.disabled = false; askBtn.textContent = 'Ask Question'; }
                if (textarea) textarea.value = '';
            }
        }

        async function clearCurrentCase() {
            try {
                const res = await fetch(`${API_BASE}/current-case`, { method: 'DELETE' });
                if (res.ok) {
                    updateCurrentCaseDisplay(null);
                }
            } catch (e) {
                console.error('Clear current case failed:', e);
            }
        }

        async function refreshCurrentCaseFromBackend() {
            try {
                const res = await fetch(`${API_BASE}/current-case`);
                if (res.ok) {
                    const data = await res.json();
                    updateCurrentCaseDisplay(data ? data.case_id : null);
                }
            } catch (e) {
                updateCurrentCaseDisplay(null);
            }
        }

        // Check model status
        async function checkModelStatus() {
            try {
                const response = await fetch(`${API_BASE}/health`);
                if (response.ok) {
                    modelHealth = await response.json();
                    updateModelStatusIndicator();
                }
            } catch (error) {
                console.error('Failed to check model status:', error);
                modelHealth = null;
                updateModelStatusIndicator();
            }
        }
        
        // Add click handler for model status
        document.addEventListener('DOMContentLoaded', function() {
            const statusEl = document.getElementById('model-status');
            if (statusEl) {
                statusEl.addEventListener('click', function() {
                    checkModelStatus();
                });
                statusEl.style.cursor = 'pointer';
            }
        });

        function getModelTypeDisplay(modelName) {
            if (!modelName) return 'MedGemma';
            const parts = String(modelName).split('/');
            return parts[parts.length - 1] || modelName;
        }

        function updateModelStatusIndicator() {
            const statusEl = document.getElementById('model-status');
            const textEl = document.getElementById('model-status-text');
            const modelType = modelHealth ? getModelTypeDisplay(modelHealth.model_name) : '';

            if (!modelHealth) {
                statusEl.className = 'lite';
                textEl.textContent = 'Lite Mode';
                statusEl.title = 'Model status unknown - click to refresh';
                return;
            }

            // Loading: MODE=model and model is currently loading
            if (modelHealth.model_loading) {
                statusEl.className = 'loading';
                textEl.textContent = 'Model loading. Please wait..';
                statusEl.title = `Model: ${modelType}\nLoading in progress. Pipeline will start when ready.\nClick to refresh`;
                return;
            }

            // Loaded: model is active
            if (modelHealth.model_loaded && !modelHealth.lite_mode) {
                statusEl.className = 'active';
                const device = modelHealth.device || 'CPU';
                textEl.textContent = `Model Active (${device}) · ${modelType}`;
                statusEl.title = `Model: ${modelType}\nDevice: ${device}\nCache: ${modelHealth.cache_size || 0} entries\nClick to refresh`;
                return;
            }

            // Model mode set but not loaded yet (e.g. load failed or not started)
            if (!modelHealth.lite_mode && !modelHealth.model_loaded) {
                statusEl.className = 'loading';
                textEl.textContent = 'Model mode · waiting for model..';
                statusEl.title = `Model: ${modelType}\nModel mode enabled. Load in progress or will start on first run.\nClick to refresh`;
                return;
            }

            // Lite mode
            statusEl.className = 'lite';
            textEl.textContent = 'Lite Mode';
            const device = modelHealth.device || 'unknown';
            statusEl.title = `Using rule-based reasoning (no model).\nDevice: ${device}\n\nTo enable model:\n1. Stop the backend\n2. Run: export MODE=model\n3. Restart the backend\n\nClick to refresh status`;
        }

        // Initialize
        async function init() {
            try {
                await checkModelStatus();
                await loadCases();
                
                await refreshCurrentCaseFromBackend();
                // If MODE=model and model is loading, wait for it before auto-running so UI shows loading state
                if (modelHealth && !modelHealth.lite_mode && (modelHealth.model_loading || !modelHealth.model_loaded)) {
                    updateModelStatusIndicator();
                    await waitForModelReady();
                    await checkModelStatus();
                }
                
                // Check URL parameters for auto-load and autoplay
                const urlParams = new URLSearchParams(window.location.search);
                const caseParam = urlParams.get('case');
                const autoplayParam = urlParams.get('autoplay');
                
                if (caseParam) {
                    const select = document.getElementById('case-select');
                    if (select) {
                        select.value = caseParam;
                    }
                    const autoPlay = autoplayParam === 'true';
                    await runCase(caseParam, autoPlay);
                } else {
                    // Default: load gotcha case with autoplay if no case specified
                    await runCase('case_02_anemia_of_inflammation_gotcha', true);
                }
            } catch (error) {
                console.error('Initialization error:', error);
                document.getElementById('hypotheses').innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">
                    <strong>Initialization Error</strong><br>
                    ${error.message}<br>
                    <small>Check browser console for details</small>
                </div>`;
            }
        }

        async function loadCases() {
            try {
                const response = await fetch(`${API_BASE}/cases`);
                if (!response.ok) {
                    throw new Error(`Failed to load cases: HTTP ${response.status}`);
                }
                const cases = await response.json();
                const select = document.getElementById('case-select');
                if (select) {
                    select.innerHTML = '';
                    cases.forEach(c => {
                        const option = document.createElement('option');
                        option.value = c.id;
                        option.textContent = c.id;
                        select.appendChild(option);
                    });
                    select.value = 'case_02_anemia_of_inflammation_gotcha';
                }
            } catch (error) {
                console.error('Failed to load cases:', error);
                // Continue anyway - user can still try to load a case manually
            }
        }

        async function loadSelectedCase() {
            const caseId = document.getElementById('case-select').value;
            await runCase(caseId, true);  // Auto-play by default when loading
        }

        async function runDemoMode() {
            await runCase('case_02_anemia_of_inflammation_gotcha', true);
        }

        const MODEL_READY_POLL_MS = 500;
        const MODEL_READY_TIMEOUT_MS = 310000; // Slightly above backend 300s

        async function waitForModelReady() {
            const start = Date.now();
            while (Date.now() - start < MODEL_READY_TIMEOUT_MS) {
                const res = await fetch(`${API_BASE}/health`);
                if (!res.ok) throw new Error('Health check failed');
                const health = await res.json();
                modelHealth = health;
                updateModelStatusIndicator();
                if (health.model_loading) {
                    await new Promise(r => setTimeout(r, MODEL_READY_POLL_MS));
                    continue;
                }
                if (health.lite_mode) return;
                if (health.model_loaded) return;
                await new Promise(r => setTimeout(r, MODEL_READY_POLL_MS));
            }
            throw new Error('Model did not become ready in time. Check server logs.');
        }

        async function streamPipeline(url, payload) {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!response.ok) {
                const errBody = await response.json().catch(() => ({}));
                const detail = errBody.detail || response.statusText;
                throw new Error(detail);
            }

            const contentType = response.headers.get('content-type') || '';
            if (!contentType.includes('text/event-stream') || !response.body) {
                const data = await response.json();
                return data;
            }

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            let finalResult = null;

            while (true) {
                const { value, done } = await reader.read();
                if (done) break;
                buffer += decoder.decode(value, { stream: true });
                const parts = buffer.split('\n\n');
                buffer = parts.pop() || '';
                for (const part of parts) {
                    const line = part.trim();
                    if (!line.startsWith('data:')) continue;
                    const jsonStr = line.replace(/^data:\s*/, '');
                    if (!jsonStr) continue;
                    let msg;
                    try {
                        msg = JSON.parse(jsonStr);
                    } catch (e) {
                        continue;
                    }
                    if (msg.type === 'events' && Array.isArray(msg.events)) {
                        msg.events.forEach(ev => {
                            events.push(ev);
                            handleEvent(ev);
                            if (ev.type === 'MODEL_REASONING_START') {
                                const banner = document.getElementById('reasoning-banner');
                                const labelEl = document.getElementById('reasoning-banner-label');
                                if (banner) banner.classList.add('visible');
                                if (labelEl && ev.payload && ev.payload.label) labelEl.textContent = ev.payload.label;
                            } else if (ev.type === 'MODEL_REASONING_END') {
                                const banner = document.getElementById('reasoning-banner');
                                if (banner) banner.classList.remove('visible');
                            }
                        });
                    } else if (msg.type === 'partial') {
                        const partial = msg.payload || {};
                        const ro = partial.reasoner_output;
                        if (!pipelineData) pipelineData = {};
                        pipelineData.reasoner_output = ro && typeof ro === 'object' ? ro : {};
                        const hyps = Array.isArray(pipelineData.reasoner_output.hypotheses) ? pipelineData.reasoner_output.hypotheses : [];
                        const acts = Array.isArray(pipelineData.reasoner_output.patient_actions) ? pipelineData.reasoner_output.patient_actions : [];
                        const ni = Array.isArray(pipelineData.reasoner_output.novel_insights) ? pipelineData.reasoner_output.novel_insights : [];
                        const na = Array.isArray(pipelineData.reasoner_output.novel_actions) ? pipelineData.reasoner_output.novel_actions : [];
                        renderHypotheses(hyps, pipelineData.evidence_bundle || {}, pipelineData.model_usage);
                        renderPatientActions(acts);
                        renderNovelInsights(ni);
                        renderNovelActions(na);
                    } else if (msg.type === 'final') {
                        const banner = document.getElementById('reasoning-banner');
                        if (banner) banner.classList.remove('visible');
                        const payload = msg.payload;
                        if (payload && payload.reasoner_output) {
                            if (!Array.isArray(payload.reasoner_output.hypotheses)) {
                                payload.reasoner_output.hypotheses = [];
                            }
                        }
                        finalResult = payload;
                    } else if (msg.type === 'error') {
                        throw new Error(msg.message || 'Streaming error');
                    }
                }
            }
            return finalResult;
        }

        async function runCase(caseId, autoPlay = false) {
            const thisLoadId = ++currentLoadId;
            const loadBtn = document.querySelector('#case-selector button');
            const caseSelect = document.getElementById('case-select');
            try {
                resetUI();
                events = [];
                pipelineData = null;
                
                if (loadBtn) loadBtn.disabled = true;
                if (caseSelect) caseSelect.disabled = true;
                
                // Show loading state
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Loading case...</div>';
                
                // When model mode, wait for model to be ready before calling /run
                const healthRes = await fetch(`${API_BASE}/health`).catch(() => null);
                if (thisLoadId !== currentLoadId) return;
                if (healthRes && healthRes.ok) {
                    const health = await healthRes.json();
                    modelHealth = health;
                    updateModelStatusIndicator();
                    if (!health.lite_mode && (health.model_loading || !health.model_loaded)) {
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #856404;">Model loading. Please wait..</div>';
                        const demoBtn = document.getElementById('demo-mode-btn');
                        if (demoBtn) demoBtn.disabled = true;
                        try {
                            await waitForModelReady();
                        } finally {
                            if (demoBtn) demoBtn.disabled = false;
                        }
                        if (thisLoadId !== currentLoadId) return;
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Loading case...</div>';
                    }
                }
                
                pipelineData = await streamPipeline(`${API_BASE}/run/stream`, { case_id: caseId });
                
                if (thisLoadId !== currentLoadId) return;
                
                if (!pipelineData || !pipelineData.evidence_bundle) {
                    throw new Error('Invalid response from backend');
                }
                if (!pipelineData.reasoner_output || !Array.isArray(pipelineData.reasoner_output.hypotheses)) {
                    document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">Invalid response shape. Missing or invalid reasoner output.</div>';
                    return;
                }
                
                events = pipelineData.events || events;
                
                await checkModelStatus();
                if (thisLoadId !== currentLoadId) return;
                
                renderInitial(pipelineData);
                updateCurrentCaseDisplay(pipelineData.current_case_id ?? pipelineData.case_id);
                updateOutputPathDisplay(pipelineData.output_path ?? null);
            } catch (error) {
                if (thisLoadId !== currentLoadId) return;
                console.error('Failed to run case:', error);
                const is503 = error.message && error.message.includes('503');
                const msg = is503
                    ? 'Model did not finish loading in time. Please try again or check server logs.'
                    : error.message;
                document.getElementById('hypotheses').innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">
                    <strong>Error loading case</strong><br>
                    ${msg}<br>
                    <small>Make sure the backend is running on http://localhost:8000</small>
                </div>`;
                alert(`Failed to load case: ${msg}\n\nMake sure the backend is running on http://localhost:8000`);
            } finally {
                if (loadBtn) loadBtn.disabled = false;
                if (caseSelect) caseSelect.disabled = false;
            }
        }

        async function runFromText(autoPlay = true) {
            const textarea = document.getElementById('analyze-text');
            const text = (textarea && textarea.value) ? textarea.value.trim() : '';
            if (!text) {
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #856404;">Enter or paste lab text above, then click Analyze.</div>';
                return;
            }
            try {
                resetUI();
                events = [];
                document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Analyzing text...</div>';
                const healthRes = await fetch(`${API_BASE}/health`).catch(() => null);
                if (healthRes && healthRes.ok) {
                    const health = await healthRes.json();
                    modelHealth = health;
                    updateModelStatusIndicator();
                    if (!health.lite_mode && (health.model_loading || !health.model_loaded)) {
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #856404;">Model loading. Please wait..</div>';
                        const analyzeBtn = document.getElementById('analyze-btn');
                        if (analyzeBtn) analyzeBtn.disabled = true;
                        try {
                            await waitForModelReady();
                        } finally {
                            if (analyzeBtn) analyzeBtn.disabled = false;
                        }
                        document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #6c757d;">Analyzing text...</div>';
                    }
                }
                const mergeWithCurrent = document.getElementById('analyze-mode-merge')?.checked === true;
                pipelineData = await streamPipeline(`${API_BASE}/analyze/stream`, { text: text, merge_with_current: mergeWithCurrent });
                if (!pipelineData || !pipelineData.evidence_bundle) {
                    throw new Error('Invalid response from backend');
                }
                if (!pipelineData.reasoner_output || !Array.isArray(pipelineData.reasoner_output.hypotheses)) {
                    document.getElementById('hypotheses').innerHTML = '<div style="padding: 20px; text-align: center; color: #f44336;">Invalid response shape. Missing or invalid reasoner output.</div>';
                    return;
                }
                events = pipelineData.events || events;
                await checkModelStatus();
                renderInitial(pipelineData);
                updateCurrentCaseDisplay(pipelineData.current_case_id ?? pipelineData.case_id);
                updateOutputPathDisplay(pipelineData.output_path ?? null);
            } catch (error) {
                console.error('Analyze failed:', error);
                const msg = error.message || 'Analyze failed';
                document.getElementById('hypotheses').innerHTML = `<div style="padding: 20px; text-align: center; color: #f44336;">
                    <strong>Analyze error</strong><br>${msg}<br>
                    <small>Try listing labs like: Ferritin 12 ng/mL, Hb 10.5 g/dL, TSH 2.6 mIU/L</small>
                </div>`;
            }
        }

        function updateSessionLabel(id) {
            sessionId = id || null;
            const el = document.getElementById('session-id-label');
            if (el) el.textContent = sessionId || 'none';
        }

        async function startSession() {
            const textarea = document.getElementById('analyze-text');
            const text = (textarea && textarea.value) ? textarea.value.trim() : '';
            if (!text) {
                alert('Paste case text first to start a session.');
                return;
            }
            try {
                resetUI();
                const res = await fetch(`${API_BASE}/session/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to start session');
                }
                const data = await res.json();
                updateSessionLabel(data.session_id);
                const output = data.output || {};
                pipelineData = output;
                events = output.events || [];
                renderInitial(output);
                updateCurrentCaseDisplay(output.current_case_id ?? output.case_id);
                updateOutputPathDisplay(output.output_path ?? null);
            } catch (e) {
                console.error('Start session failed:', e);
                alert(`Failed to start session: ${e.message || e}`);
            }
        }

        async function sendSessionMessage() {
            if (!sessionId) {
                alert('Start a session first.');
                return;
            }
            const textarea = document.getElementById('analyze-text');
            const message = (textarea && textarea.value) ? textarea.value.trim() : '';
            if (!message) {
                alert('Enter a follow-up message.');
                return;
            }
            try {
                const res = await fetch(`${API_BASE}/session/${sessionId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message })
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    throw new Error(err.detail || 'Failed to send message');
                }
                const data = await res.json();
                if (data.turn_type === 'explanation') {
                    const el = document.getElementById('explanation-content');
                    if (el) el.innerHTML = `<div style="padding: 12px; font-size: 13px; line-height: 1.5;">${data.explanation || 'No explanation available.'}</div>`;
                    showTab('explanation');
                } else if (data.turn_type === 'update') {
                    const output = data.output || {};
                    pipelineData = output;
                    events = output.events || [];
                    renderInitial(output);
                    updateCurrentCaseDisplay(output.current_case_id ?? output.case_id);
                    updateOutputPathDisplay(output.output_path ?? null);
                } else {
                    alert(data.message || 'Please add new clinical info or ask for an explanation.');
                }
            } catch (e) {
                console.error('Session message failed:', e);
                alert(`Failed to send message: ${e.message || e}`);
            }
        }

        function resetUI() {
            currentEventIndex = 0;
            isPlaying = false;
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            // Clear all animation timeouts
            animationTimeouts.forEach(timeout => clearTimeout(timeout));
            animationTimeouts = [];
            
            document.querySelectorAll('.step-chip').forEach(chip => {
                chip.classList.remove('active', 'completed');
            });
            const durationIds = ['LAB_NORMALIZE', 'CONTEXT_SELECT', 'EVIDENCE_SCORE', 'REASON', 'CRITIC', 'GUARDRAILS', 'FINAL'];
            durationIds.forEach(step => {
                const el = document.getElementById('duration-' + step);
                if (el) el.textContent = '';
            });
            document.getElementById('play-pause-btn').textContent = '▶ Play';
            document.getElementById('play-pause-btn').classList.remove('active');
            document.getElementById('trust-moments').innerHTML = '';
            highlightedNodes.clear();
            highlightedEdges.clear();
            
            // Destroy graph so next load starts from scratch
            if (cy) {
                try { cy.destroy(); } catch (e) {}
                cy = null;
            }
            const cyEl = document.getElementById('cy');
            if (cyEl) {
                cyEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6c757d;font-size:14px;">Loading case…</div>';
            }
            
            // Clear all case-specific panels so Load always starts from scratch
            const caseOverviewWrap = document.getElementById('case-overview-wrap');
            const caseOverview = document.getElementById('case-overview');
            if (caseOverviewWrap) caseOverviewWrap.style.display = 'none';
            if (caseOverview) caseOverview.textContent = '';
            const guidanceContent = document.getElementById('guidance-content');
            if (guidanceContent) guidanceContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Load a case to see step-by-step guidance</div>';
            const explanationContent = document.getElementById('explanation-content');
            if (explanationContent) explanationContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Ask a follow-up question to see an explanation</div>';
            const nextStepsContent = document.getElementById('next-steps-content');
            if (nextStepsContent) nextStepsContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Load a case to see recommended next steps</div>';
            const abnormalLabsEl = document.getElementById('abnormal-labs');
            if (abnormalLabsEl) abnormalLabsEl.innerHTML = '';
            
            // Reset reasoning trace
            const traceCheckbox = document.getElementById('trace-checkbox');
            const traceContent = document.getElementById('reasoning-trace-content');
            if (traceCheckbox) traceCheckbox.checked = false;
            if (traceContent) {
                traceContent.classList.remove('active');
                traceContent.innerHTML = '';
            }
            
            // Clear hypotheses and actions
            document.getElementById('hypotheses').innerHTML = '';
            document.getElementById('actions').innerHTML = '';
            document.getElementById('novel-insights').innerHTML = '';
            document.getElementById('novel-actions').innerHTML = '';

            // Hide reasoning banner
            const reasoningBanner = document.getElementById('reasoning-banner');
            if (reasoningBanner) reasoningBanner.classList.remove('visible');
            
            stepDurations = {};
        }

        function renderInitial(data) {
            if (!data) return;

            // Update Patient, Guidance, Next Steps (and hypotheses) first so they show even if graph build throws
            if (data.reasoner_output) {
                renderHypotheses(data.reasoner_output.hypotheses || [], data.evidence_bundle || {}, data.model_usage);
                renderPatientActions(data.reasoner_output.patient_actions || []);
                renderNovelInsights(data.reasoner_output.novel_insights || []);
                renderNovelActions(data.reasoner_output.novel_actions || []);
                renderGuidance(data);
                renderNextSteps(data);
            }

            // Case overview (patient impression) when present
            const wrap = document.getElementById('case-overview-wrap');
            const block = document.getElementById('case-overview');
            if (data.case_impression) {
                block.textContent = data.case_impression;
                wrap.style.display = 'block';
            } else {
                block.textContent = '';
                wrap.style.display = 'none';
            }

            // Unlinked markers (added to graph but not yet linked to patterns)
            const unlinkedWrap = document.getElementById('unlinked-markers-wrap');
            const unlinkedNote = document.getElementById('unlinked-markers-note');
            if (data.unlinked_markers && data.unlinked_markers.length > 0) {
                unlinkedNote.textContent = 'The following were added to the graph but are not yet linked to patterns: ' + data.unlinked_markers.join(', ') + '.';
                unlinkedWrap.style.display = 'block';
            } else {
                unlinkedNote.textContent = '';
                unlinkedWrap.style.display = 'none';
            }

            // Unmappable inputs (could not be mapped to the graph)
            const unmappableWrap = document.getElementById('unmappable-inputs-wrap');
            const unmappableNote = document.getElementById('unmappable-inputs-note');
            if (data.unmappable_inputs && data.unmappable_inputs.length > 0) {
                unmappableNote.textContent = 'The following could not be mapped to the graph: ' + data.unmappable_inputs.join(', ') + '. Consider adding labs or standard terms.';
                unmappableWrap.style.display = 'block';
            } else {
                unmappableNote.textContent = '';
                unmappableWrap.style.display = 'none';
            }

            // Render abnormal labs (status display: Reference unknown when uncertain; show ref range when available)
            const normalizedLabs = data.normalized_labs || [];
            const abnormalLabs = normalizedLabs.filter(lab => lab && lab.status !== 'NORMAL');
            const labsHtml = abnormalLabs.map(lab => {
                const statusDisplay = lab.status === 'REFERENCE_UNKNOWN' ? 'Reference unknown' : (lab.status || '');
                const labClass = lab.status === 'REFERENCE_UNKNOWN' ? 'unknown' : (lab.status || '');
                const hasRef = lab.ref_low != null && lab.ref_high != null && (lab.ref_low !== 0 || lab.ref_high !== 0);
                const refStr = hasRef ? `; ref ${lab.ref_low}–${lab.ref_high} ${(lab.unit || '').trim()}`.trim() : '';
                return `
                <div class="lab-item ${labClass}" data-marker="${lab.marker || ''}">
                    <div class="marker-name">${lab.marker || ''}</div>
                    <div class="lab-value">${lab.value} ${(lab.unit || '').trim()} (${statusDisplay}${refStr})</div>
                </div>
            `}).join('');
            const abnormalLabsEl = document.getElementById('abnormal-labs');
            if (abnormalLabsEl) abnormalLabsEl.innerHTML = labsHtml;

            // Build graph only when evidence_bundle and subgraph exist with non-empty nodes/edges
            const subgraph = data.evidence_bundle && data.evidence_bundle.subgraph;
            const nodes = subgraph && Array.isArray(subgraph.nodes) ? subgraph.nodes : null;
            const edges = subgraph && Array.isArray(subgraph.edges) ? subgraph.edges : null;
            const hasGraphData = nodes && nodes.length > 0 && edges;
            if (!hasGraphData) {
                const cyEl = document.getElementById('cy');
                if (cyEl) cyEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#6c757d;font-size:13px;">No graph data for this case.</div>';
                if (cy) {
                    try { cy.destroy(); } catch (e) {}
                    cy = null;
                }
                extractStepDurations();
                setTimeout(() => renderAgentActivity(), 100);
                return;
            }

            const cyEl = document.getElementById('cy');
            try {
                if (cy) {
                    try { cy.destroy(); } catch (e) {}
                    cy = null;
                }
                if (cyEl) cyEl.innerHTML = '';

                const elements = [];
                const nodeMap = {};
                const nodeIds = new Set();

                nodes.forEach(node => {
                    if (!node || node.id == null) return;
                    if (nodeIds.has(node.id)) return;
                    nodeIds.add(node.id);
                    nodeMap[node.id] = node;
                    const nodeData = {
                        id: String(node.id),
                        label: node.label != null ? node.label : node.id,
                        type: node.type != null ? node.type : 'Marker'
                    };
                    if (node.dynamic === true) nodeData.dynamic = true;
                    elements.push({ data: nodeData });
                });

                const edgeIds = new Set();
                edges.forEach(edge => {
                    if (!edge || edge.id == null) return;
                    if (edgeIds.has(edge.id)) return;
                    const source = edge.from_ != null ? edge.from_ : edge.from;
                    const target = edge.to;
                    if (source == null || target == null) return;
                    const src = String(source);
                    const tgt = String(target);
                    edgeIds.add(edge.id);
                    elements.push({
                        data: {
                            id: String(edge.id),
                            source: src,
                            target: tgt,
                            label: edge.relation,
                            relation: edge.relation
                        }
                    });
                });

                // Initialize Cytoscape with beautiful styling
                cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': '70px',
                            'height': '70px',
                            'background-color': '#e0e0e0',
                            'color': '#333',
                            'font-size': '13px',
                            'font-weight': '600',
                            'text-wrap': 'wrap',
                            'text-max-width': '90px',
                            'border-width': 3,
                            'border-color': '#999',
                            'shape': 'round-rectangle',
                            'transition-property': 'background-color, border-color, width, height, filter, shape',
                            'transition-duration': '0.4s',
                            'transition-timing-function': 'cubic-bezier(0.4, 0, 0.2, 1)'
                        }
                    },
                    {
                        selector: 'node[type="Marker"]',
                        style: {
                            'background-color': '#a8c7fa',
                            'border-color': '#1a73e8',
                            'background-opacity': 0.9,
                            'shape': 'round-rectangle'
                        }
                    },
                    {
                        selector: 'node[type="Pattern"]',
                        style: {
                            'background-color': '#a8dab5',
                            'border-color': '#137333',
                            'background-opacity': 0.9,
                            'shape': 'ellipse'
                        }
                    },
                    {
                        selector: 'node[type="Condition"]',
                        style: {
                            'background-color': '#fdd663',
                            'border-color': '#ea8600',
                            'background-opacity': 0.9,
                            'shape': 'round-octagon'
                        }
                    },
                    {
                        selector: 'node[type="Test"]',
                        style: {
                            'background-color': '#d7aefb',
                            'border-color': '#7b1fa2',
                            'background-opacity': 0.9,
                            'shape': 'diamond'
                        }
                    },
                    {
                        selector: 'node[dynamic]',
                        style: {
                            'border-width': 4,
                            'border-color': '#E65100',
                            'border-style': 'double',
                            'background-color': '#FFE0B2'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'label': 'data(label)',
                            'width': 2,
                            'line-color': '#999',
                            'target-arrow-color': '#999',
                            'target-arrow-shape': 'triangle',
                            'target-arrow-size': '8px',
                            'curve-style': 'bezier',
                            'font-size': '10px',
                            'text-rotation': 'autorotate',
                            'text-margin-y': -12,
                            'opacity': 0.5,
                            'transition-property': 'line-color, width, opacity, target-arrow-color, line-style',
                            'transition-duration': '0.4s',
                            'transition-timing-function': 'cubic-bezier(0.4, 0, 0.2, 1)'
                        }
                    },
                    {
                        selector: 'edge[relation="SUPPORTS"]',
                        style: {
                            'line-color': '#137333',
                            'target-arrow-color': '#137333',
                            'width': 3,
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'edge[relation="CONTRADICTS"]',
                        style: {
                            'line-color': '#c5221f',
                            'target-arrow-color': '#c5221f',
                            'width': 3,
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'edge[relation="RECOMMENDS_TEST"]',
                        style: {
                            'line-color': '#ea8600',
                            'target-arrow-color': '#ea8600',
                            'width': 4,
                            'line-style': 'dashed',
                            'opacity': 0.8
                        }
                    },
                    {
                        selector: 'edge[relation="CAUSES"], edge[relation="INCREASES"], edge[relation="DECREASES"]',
                        style: {
                            'line-color': '#1a73e8',
                            'target-arrow-color': '#1a73e8',
                            'width': 3,
                            'opacity': 0.7
                        }
                    },
                    {
                        selector: 'node.highlighted',
                        style: {
                            'background-color': '#1a73e8',
                            'border-color': '#1557b0',
                            'border-width': 4,
                            'width': '85px',
                            'height': '85px',
                            'z-index': 999
                        }
                    },
                    {
                        selector: 'edge.highlighted',
                        style: {
                            'line-color': '#1a73e8',
                            'target-arrow-color': '#1a73e8',
                            'width': 5,
                            'opacity': 1,
                            'z-index': 998
                        }
                    },
                    {
                        selector: 'edge.conclusion-support',
                        style: {
                            'line-color': '#137333',
                            'target-arrow-color': '#137333',
                            'width': 4,
                            'opacity': 1,
                            'z-index': 997
                        }
                    },
                    {
                        selector: 'node.conclusion-recommended',
                        style: {
                            'background-color': '#7b1fa2',
                            'border-color': '#4a148c',
                            'border-width': 5,
                            'z-index': 996
                        }
                    },
                    {
                        selector: 'edge.conclusion-recommended',
                        style: {
                            'line-color': '#7b1fa2',
                            'target-arrow-color': '#7b1fa2',
                            'width': 4,
                            'line-style': 'dashed',
                            'opacity': 1,
                            'z-index': 995
                        }
                    },
                    {
                        selector: 'node.pulsing',
                        style: {
                            'background-color': '#34a853',
                            'border-color': '#137333',
                            'border-width': 5
                        }
                    },
                    {
                        selector: 'edge.flowing',
                        style: {
                            'line-color': '#1a73e8',
                            'target-arrow-color': '#1a73e8',
                            'width': 5
                        }
                    }
                ],
                layout: {
                    name: 'cose',
                    idealEdgeLength: 120,
                    nodeOverlap: 25,
                    refresh: 20,
                    fit: true,
                    padding: 40,
                    randomize: false,
                    componentSpacing: 120,
                    nodeRepulsion: 4500000,
                    edgeElasticity: 120,
                    nestingFactor: 6,
                    gravity: 0.3,
                    numIter: 1200,
                    initialTemp: 250,
                    coolingFactor: 0.95,
                    minTemp: 1.5
                }
            });

                // Extract step durations
                extractStepDurations();

                // Update reasoning trace if it was previously visible
                const traceCheckbox = document.getElementById('trace-checkbox');
                if (traceCheckbox && traceCheckbox.checked) {
                    renderReasoningTrace();
                }

                // Render agent activity (will be called after events are processed)
                setTimeout(() => renderAgentActivity(), 100);
            } catch (graphErr) {
                console.error('Graph build failed:', graphErr);
                if (cy) {
                    try { cy.destroy(); } catch (e) {}
                    cy = null;
                }
                if (cyEl) {
                    cyEl.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:#856404;font-size:13px;padding:12px;text-align:center;">Graph could not be drawn. Check console for details.</div>';
                }
                extractStepDurations();
                setTimeout(() => renderAgentActivity(), 100);
            }
        }

        function extractStepDurations() {
            stepDurations = {};
            const stepStartTimes = {};
            
            events.forEach(event => {
                if (!event || event.step == null) return;
                if (event.type === 'STEP_START') {
                    stepStartTimes[event.step] = Date.now();
                } else if (event.type === 'STEP_END' && event.payload) {
                    const startTime = stepStartTimes[event.step];
                    const durationMs = event.payload.duration_ms;
                    if (startTime && durationMs != null) {
                        stepDurations[event.step] = durationMs;
                        const durationEl = document.getElementById(`duration-${event.step}`);
                        if (durationEl) {
                            durationEl.textContent = `(${Math.round(durationMs)}ms)`;
                        }
                    }
                }
            });
        }

        function renderHypotheses(hypotheses, evidenceBundle, modelUsage) {
            if (!hypotheses || hypotheses.length === 0) {
                const hint = (modelUsage && modelUsage.model_mode)
                    ? '<div style="padding: 4px 0 0 0; font-size: 11px; color: #999;">Check Reasoning Trace for details.</div>'
                    : '';
                document.getElementById('hypotheses').innerHTML =
                    '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">No hypotheses generated for this case.</div>' + hint;
                return;
            }
            
            // Sort hypotheses by confidence (descending) if not already sorted
            const sortedHypotheses = [...hypotheses].sort((a, b) => (b.confidence || 0) - (a.confidence || 0));
            
            const hypothesesHtml = sortedHypotheses.map((hypo, idx) => {
                const nextTests = hypo.next_tests || [];
                const nextTestsList = Array.isArray(nextTests) && nextTests.length > 0 
                    ? nextTests.map(test => {
                        const testLabel = typeof test === 'string' ? test : (test.label || test.test_id || test);
                        const testRationale = typeof test === 'object' && test.rationale ? ` <span style="font-size: 10px; color: #666; font-style: italic;">(${test.rationale})</span>` : '';
                        return `<li>${testLabel}${testRationale}</li>`;
                    }).join('')
                    : '<li>None</li>';
                
                // Color code confidence badge
                const confidence = hypo.confidence || 0;
                let confidenceClass = 'confidence';
                let confidenceLabel = '';
                if (confidence >= 0.7) {
                    confidenceClass += ' high-confidence';
                    confidenceLabel = 'Very likely';
                } else if (confidence >= 0.4) {
                    confidenceClass += ' medium-confidence';
                    confidenceLabel = 'Possible';
                } else {
                    confidenceClass += ' low-confidence';
                    confidenceLabel = 'Unlikely';
                }
                
                // Show evidence count
                const evidenceCount = (hypo.evidence || []).length;
                const counterEvidenceCount = (hypo.counter_evidence || []).length;
                
                // What would change my mind
                const changeMind = hypo.what_would_change_my_mind || [];
                const changeMindHtml = changeMind.length > 0 ? `
                    <div style="margin-top: 10px; padding: 10px 12px; background: var(--c-bg); border-radius: var(--r-md); border-left: 3px solid var(--c-primary);">
                        <div style="font-size: 11px; font-weight: 600; color: var(--c-primary); margin-bottom: 4px;">What would change my mind</div>
                        <ul style="margin: 0; padding-left: 18px; font-size: 11px; color: var(--c-text-sec); line-height: 1.5;">
                            ${changeMind.map(item => `<li>${item}</li>`).join('')}
                        </ul>
                    </div>
                ` : '';
                
                const updatedBadge = hypo.merge_updated
                    ? '<span style="font-size: 10px; background: #e8f5e9; color: #2e7d32; padding: 2px 6px; border-radius: 10px; margin-left: 6px;">Updated</span>'
                    : '';
                const reasoningText = hypo.reasoning && String(hypo.reasoning).trim();
                const reasoningHtml = reasoningText ? `
                    <div style="margin-top: 10px; padding: 10px 12px; background: var(--c-primary-light); border-radius: var(--r-md); border-left: 3px solid var(--c-primary);">
                        <div style="font-size: 10px; font-weight: 600; color: var(--c-primary-dark); margin-bottom: 3px; text-transform: uppercase; letter-spacing: .3px;">MedGemma Reasoning</div>
                        <div style="font-size: 12px; color: var(--c-text); line-height: 1.6;">${reasoningText}</div>
                    </div>
                ` : '';
                return `
                    <div class="hypothesis-card" data-hypothesis-id="${hypo.id || idx}" style="order: ${idx};">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center;">
                                <h4 style="margin: 0;">${hypo.name}</h4>
                                ${updatedBadge}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <span class="${confidenceClass}">${Math.round(confidence * 100)}%</span>
                                <span style="font-size: 9px; color: #999; margin-top: 2px;">${confidenceLabel}</span>
                            </div>
                        </div>
                        ${evidenceCount > 0 || counterEvidenceCount > 0 ? `
                            <div style="font-size: 11px; color: var(--c-text-ter); margin-bottom: 8px;">
                                ${evidenceCount > 0 ? `<span style="color: var(--c-success);">${evidenceCount} supporting</span>` : ''}
                                ${counterEvidenceCount > 0 ? `<span style="color: var(--c-error); margin-left: 8px;">${counterEvidenceCount} contradicting</span>` : ''}
                            </div>
                        ` : ''}
                        ${reasoningHtml}
                        ${nextTests.length > 0 ? `
                            <div class="next-tests" style="margin-bottom: 10px;">
                                <h5 style="font-size: 12px; font-weight: 600; color: #495057; margin-bottom: 6px;">Recommended Tests:</h5>
                                <ul style="margin: 0; padding-left: 18px; font-size: 11px; color: #495057; line-height: 1.5;">${nextTestsList}</ul>
                            </div>
                        ` : ''}
                        ${changeMindHtml}
                    </div>
                `;
            }).join('');
            
            document.getElementById('hypotheses').innerHTML = hypothesesHtml;
        }

        function renderPatientActions(actions) {
            if (!actions || actions.length === 0) {
                document.getElementById('actions').innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">No patient actions recommended for this case.</div>';
                return;
            }
            
            // Sort by risk level (high -> medium -> low)
            const riskOrder = { 'high': 0, 'medium': 1, 'low': 2, 'none': 3 };
            const sortedActions = [...actions].sort((a, b) => {
                const aRisk = riskOrder[a.risk] ?? 3;
                const bRisk = riskOrder[b.risk] ?? 3;
                return aRisk - bRisk;
            });
            
            const actionsHtml = sortedActions.map(action => {
                const bucket = action.bucket || 'general';
                const bucketLabels = {
                    'immediate': 'Immediate',
                    'short_term': 'Short-term',
                    'monitoring': 'Monitoring',
                    'lifestyle': 'Lifestyle',
                    'general': 'General'
                };
                return `
                    <div class="action-card" style="margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <div class="task" style="flex: 1;">${action.task}</div>
                            ${action.risk ? `<span class="risk ${action.risk}" style="margin-left: 8px;">${action.risk} risk</span>` : ''}
                        </div>
                        ${action.why ? `<div class="why" style="font-size: 12px; color: #666; margin-bottom: 6px;">${action.why}</div>` : ''}
                        ${bucket !== 'general' ? `<div style="font-size: 10px; color: #999; font-style: italic;">Category: ${bucketLabels[bucket] || bucket}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            document.getElementById('actions').innerHTML = actionsHtml;
        }

        function renderNovelInsights(novelInsights) {
            if (!novelInsights || novelInsights.length === 0) {
                document.getElementById('novel-insights').innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px; text-align: center;">No novel insights for this case.</div>';
                return;
            }
            const insightsHtml = novelInsights.map(item => {
                return `
                    <div class="hypothesis-card" style="border-left: 3px solid var(--c-warning);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="font-weight: 600; color: var(--c-text);">${item.insight || 'Novel insight'}</div>
                            <span style="font-size: 10px; background: var(--c-warning-bg); color: #b06000; padding: 2px 8px; border-radius: var(--r-pill); font-weight: 500;">Outside KG</span>
                        </div>
                        ${item.rationale ? `<div style="font-size: 12px; color: #666;">${item.rationale}</div>` : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('novel-insights').innerHTML = insightsHtml;
        }

        function renderNovelActions(actions) {
            if (!actions || actions.length === 0) {
                document.getElementById('novel-actions').innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px; text-align: center;">No novel actions for this case.</div>';
                return;
            }
            const actionsHtml = actions.map(action => {
                return `
                    <div class="action-card" style="margin-bottom: 10px; border-left: 3px solid var(--c-warning);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 6px;">
                            <div class="task" style="flex: 1;">${action.task}</div>
                            <div style="display: flex; gap: 6px; align-items: center;">
                                <span style="font-size: 10px; background: var(--c-warning-bg); color: #b06000; padding: 2px 8px; border-radius: var(--r-pill); font-weight: 500;">Outside KG</span>
                                ${action.risk ? `<span class="risk ${action.risk}" style="margin-left: 4px;">${action.risk} risk</span>` : ''}
                            </div>
                        </div>
                        ${action.why ? `<div class="why" style="font-size: 12px; color: #666; margin-bottom: 6px;">${action.why}</div>` : ''}
                    </div>
                `;
            }).join('');
            document.getElementById('novel-actions').innerHTML = actionsHtml;
        }

        function renderGuidance(data) {
            const guidanceContent = document.getElementById('guidance-content');
            if (!guidanceContent) return;
            if (!data || !data.events) {
                guidanceContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Load a case to see step-by-step guidance</div>';
                return;
            }
            
            const events = data.events || [];
            const stepExplanations = {
                'LAB_NORMALIZE': {
                    title: 'Lab Normalization',
                    description: 'Converting raw lab values into standardized formats and identifying abnormal values that need attention.',
                    icon: '1'
                },
                'CONTEXT_SELECT': {
                    title: 'Context Selection',
                    description: 'Identifying relevant medical patterns and conditions from the knowledge graph based on abnormal lab values.',
                    icon: '2'
                },
                'EVIDENCE_SCORE': {
                    title: 'Evidence Scoring',
                    description: 'Evaluating how strongly each piece of evidence supports or contradicts potential diagnoses.',
                    icon: '3'
                },
                'REASON': {
                    title: 'Reasoning',
                    description: 'Generating diagnostic hypotheses by combining evidence scores with medical knowledge.',
                    icon: '4'
                },
                'CRITIC': {
                    title: 'Critic Review',
                    description: 'Reviewing hypotheses for safety and evidence alignment; applying corrections.',
                    icon: '5'
                },
                'GUARDRAILS': {
                    title: 'Safety Guardrails',
                    description: 'Checking recommendations against safety rules to prevent harmful actions.',
                    icon: '6'
                },
                'FINAL': {
                    title: 'Final Output',
                    description: 'Compiling final recommendations with safety checks applied.',
                    icon: '7'
                }
            };
            
            let html = '';
            const completedSteps = new Set();
            events.forEach(event => {
                if (event && event.type === 'STEP_END' && event.step != null) {
                    completedSteps.add(event.step);
                }
            });
            
            Object.keys(stepExplanations).forEach(step => {
                const info = stepExplanations[step];
                const isCompleted = completedSteps.has(step);
                const isActive = events.some(e => e && e.step === step && e.type === 'STEP_START' && !completedSteps.has(step));
                
                html += `
                    <div style="margin-bottom: 10px; padding: 12px 14px; background: ${isCompleted ? 'var(--c-success-bg)' : isActive ? 'var(--c-primary-light)' : 'var(--c-bg)'}; border-radius: var(--r-md); border-left: 3px solid ${isCompleted ? 'var(--c-success)' : isActive ? 'var(--c-primary)' : 'var(--c-border)'};">
                        <div style="display: flex; align-items: center; margin-bottom: 4px;">
                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 22px; height: 22px; border-radius: 50%; background: ${isCompleted ? 'var(--c-success)' : isActive ? 'var(--c-primary)' : 'var(--c-text-ter)'}; color: #fff; font-size: 11px; font-weight: 600; margin-right: 10px; flex-shrink: 0;">${info.icon}</span>
                            <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: var(--c-text);">${info.title}</h4>
                            ${isCompleted ? '<span style="margin-left: auto; color: var(--c-success); font-size: 11px; font-weight: 500;">Complete</span>' : isActive ? '<span style="margin-left: auto; color: var(--c-primary); font-size: 11px; font-weight: 500;">In progress</span>' : ''}
                        </div>
                        <div style="font-size: 12px; color: var(--c-text-sec); line-height: 1.5; margin-left: 32px;">${info.description}</div>
                    </div>
                `;
            });
            
            // Add gotcha case explanation if applicable
            const caseId = data.case_card?.case_id || '';
            if (caseId.includes('gotcha') || caseId.includes('inflammation')) {
                html += `
                    <div style="margin-top: 16px; padding: 14px; background: var(--c-warning-bg); border-radius: var(--r-md); border-left: 3px solid var(--c-warning);">
                        <h4 style="margin: 0 0 6px 0; font-size: 13px; font-weight: 600; color: #b06000;">Clinical Note: Anemia of Inflammation</h4>
                        <div style="font-size: 12px; color: var(--c-text); line-height: 1.6;">
                            <p style="margin: 0 0 6px 0;">This case demonstrates a common diagnostic challenge: <strong>high ferritin levels during inflammation</strong> can mask iron deficiency.</p>
                            <p style="margin: 0 0 6px 0;">The system detected that iron supplementation would be unsafe because:</p>
                            <ul style="margin: 0 0 6px 0; padding-left: 20px; color: var(--c-text-sec);">
                                <li>Ferritin is an acute-phase reactant (increases during inflammation)</li>
                                <li>Supplementing iron during active inflammation can worsen the condition</li>
                                <li>The underlying inflammation must be addressed first</li>
                            </ul>
                            <p style="margin: 0; font-weight: 600; color: #b06000;">The guardrail system automatically removed the unsafe recommendation.</p>
                        </div>
                    </div>
                `;
            }
            
            guidanceContent.innerHTML = html;
        }

        function renderNextSteps(data) {
            const nextStepsContent = document.getElementById('next-steps-content');
            if (!nextStepsContent) return;
            if (!data || !data.reasoner_output) {
                nextStepsContent.innerHTML = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">Load a case to see recommended next steps</div>';
                return;
            }
            
            const hypotheses = data.reasoner_output.hypotheses || [];
            const actions = data.reasoner_output.patient_actions || [];
            
            let html = '';
            
            // Priority tests
            const allTests = [];
            hypotheses.forEach(hypo => {
                (hypo.next_tests || []).forEach(test => {
                    if (test == null) return;
                    const testName = typeof test === 'string' ? test : (test.label || test.test_id || test);
                    if (!testName) return;
                    if (!allTests.includes(testName)) {
                        allTests.push(testName);
                    }
                });
            });
            
            if (allTests.length > 0) {
                html += `
                    <div style="margin-bottom: 12px; padding: 12px 14px; background: var(--c-primary-light); border-radius: var(--r-md); border-left: 3px solid var(--c-primary);">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: var(--c-primary-dark); text-transform: uppercase; letter-spacing: .3px;">Priority Tests</h4>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: var(--c-text); line-height: 1.6;">
                            ${allTests.map(test => `<li>${test}</li>`).join('')}
                        </ul>
                        <div style="margin-top: 6px; font-size: 11px; color: var(--c-text-ter);">Order these tests to confirm or rule out the top hypotheses.</div>
                    </div>
                `;
            }
            
            // Monitoring recommendations
            const monitoringActions = actions.filter(a => {
                const task = a && a.task;
                return a.bucket === 'monitoring' || (typeof task === 'string' && safeLower(task).includes('monitor'));
            });
            if (monitoringActions.length > 0) {
                html += `
                    <div style="margin-bottom: 12px; padding: 12px 14px; background: var(--c-warning-bg); border-radius: var(--r-md); border-left: 3px solid var(--c-warning);">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #b06000; text-transform: uppercase; letter-spacing: .3px;">Monitoring</h4>
                        <ul style="margin: 0; padding-left: 18px; font-size: 12px; color: var(--c-text); line-height: 1.6;">
                            ${monitoringActions.map(a => `<li>${a.task}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // Follow-up timing
            const topHypothesis = hypotheses[0];
            if (topHypothesis) {
                const confidence = topHypothesis.confidence || 0;
                let followUpTiming = '';
                if (confidence >= 0.7) {
                    followUpTiming = 'Schedule follow-up in 1-2 weeks to assess treatment response.';
                } else if (confidence >= 0.4) {
                    followUpTiming = 'Schedule follow-up in 2-4 weeks after diagnostic tests are completed.';
                } else {
                    followUpTiming = 'Consider follow-up in 4-6 weeks or sooner if symptoms worsen.';
                }
                
                html += `
                    <div style="margin-bottom: 12px; padding: 12px 14px; background: #f3e8fd; border-radius: var(--r-md); border-left: 3px solid #7b1fa2;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #7b1fa2; text-transform: uppercase; letter-spacing: .3px;">Follow-up Timing</h4>
                        <div style="font-size: 12px; color: var(--c-text); line-height: 1.6;">${followUpTiming}</div>
                    </div>
                `;
            }
            
            // Safety note if guardrails were applied
            if (data.guardrail_report && data.guardrail_report.failed_rules && data.guardrail_report.failed_rules.length > 0) {
                html += `
                    <div style="margin-bottom: 12px; padding: 12px 14px; background: var(--c-error-bg); border-radius: var(--r-md); border-left: 3px solid var(--c-error);">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: var(--c-error); text-transform: uppercase; letter-spacing: .3px;">Safety Note</h4>
                        <div style="font-size: 12px; color: var(--c-text); line-height: 1.6;">
                            The system automatically removed unsafe recommendations. Review the Guidance tab for details.
                        </div>
                    </div>
                `;
            }
            
            if (!html) {
                html = '<div style="padding: 16px; color: #6c757d; font-size: 13px; text-align: center;">No specific next steps available for this case.</div>';
            }
            
            nextStepsContent.innerHTML = html;
        }

        function playEvents() {
            if (isPlaying) return;
            
            isPlaying = true;
            document.getElementById('play-pause-btn').textContent = '⏸ Pause';
            document.getElementById('play-pause-btn').classList.add('active');
            
            playInterval = setInterval(() => {
                if (currentEventIndex < events.length) {
                    handleEvent(events[currentEventIndex]);
                    currentEventIndex++;
                } else {
                    pauseEvents();
                    // Finalize graph state after all events complete
                    setTimeout(() => {
                        finalizeGraphState();
                    }, 500);
                }
            }, 900);
        }

        function pauseEvents() {
            isPlaying = false;
            if (playInterval) {
                clearInterval(playInterval);
                playInterval = null;
            }
            document.getElementById('play-pause-btn').textContent = '▶ Play';
            document.getElementById('play-pause-btn').classList.remove('active');
        }

        function togglePlayPause() {
            if (isPlaying) {
                pauseEvents();
            } else {
                playEvents();
            }
        }

        function replay() {
            currentEventIndex = 0;
            resetUI();
            // Reset graph to initial state with smooth fade
            if (cy) {
                cy.nodes().style({
                    'background-color': null,
                    'border-color': null,
                    'border-width': null,
                    'width': null,
                    'height': null
                }).removeClass('highlighted pulsing conclusion-support conclusion-recommended');
                cy.edges().style({
                    'line-color': null,
                    'target-arrow-color': null,
                    'width': null,
                    'opacity': null
                }).removeClass('highlighted flowing conclusion-support conclusion-recommended');
            }
            document.getElementById('trust-moments').innerHTML = '';
            document.querySelectorAll('.lab-item').forEach(item => {
                item.classList.remove('pulse');
            });
            document.querySelectorAll('.step-chip').forEach(chip => {
                chip.classList.remove('active', 'completed');
            });
            playEvents();
        }

        function jumpToEnd() {
            pauseEvents();
            currentEventIndex = events.length;
            events.forEach(event => handleEvent(event));
            document.querySelectorAll('.step-chip').forEach(chip => {
                chip.classList.add('completed');
                chip.classList.remove('active');
            });
            // Finalize graph state after all events
            setTimeout(() => {
                finalizeGraphState();
            }, 500);
        }

        function handleEvent(event) {
            if (!event) return;
            const step = event.step;
            const type = event.type;
            if (step == null || type == null) return;
            
            updateTimeline(step, type);
            
            switch (type) {
                case 'HIGHLIGHT':
                    handleHighlight(event);
                    break;
                case 'GUARDRAIL_FAIL':
                    handleGuardrailFail(event);
                    break;
                case 'GUARDRAIL_PATCH_APPLIED':
                    handleGuardrailPatch(event);
                    break;
                case 'HYPOTHESIS_READY':
                    handleHypothesisReady(event);
                    break;
                case 'CANDIDATES':
                    handleCandidates(event);
                    break;
                case 'EVIDENCE_APPLIED':
                    handleEvidenceApplied(event);
                    break;
                case 'MODEL_REASONING_START': {
                    const banner = document.getElementById('reasoning-banner');
                    const labelEl = document.getElementById('reasoning-banner-label');
                    if (banner) banner.classList.add('visible');
                    if (labelEl && event.payload && event.payload.label) labelEl.textContent = event.payload.label;
                    break;
                }
                case 'MODEL_REASONING_END': {
                    const banner = document.getElementById('reasoning-banner');
                    if (banner) banner.classList.remove('visible');
                    break;
                }
            }
        }

        function updateTimeline(step, type) {
            if (step == null || type == null) return;
            const chip = document.querySelector(`[data-step="${step}"]`);
            if (!chip) return;
            
            if (type === 'STEP_START') {
                chip.classList.add('active');
                chip.classList.remove('completed');
            } else if (type === 'STEP_END') {
                chip.classList.remove('active');
                chip.classList.add('completed');
            }
        }

        function handleHighlight(event) {
            if (!cy || typeof cy.getElementById !== 'function') {
                return;
            }
            const payload = event.payload || {};
            const nodeIds = payload.node_ids || [];
            const edgeIds = payload.edge_ids || [];
            
            // Smooth fade out previous highlights
            highlightedNodes.forEach(id => {
                const node = cy.getElementById(id);
                if (node.length) {
                    node.animate({
                        style: {
                            'background-color': null,
                            'border-color': null,
                            'border-width': 3,
                            'width': '70px',
                            'height': '70px'
                        }
                    }, {
                        duration: 400,
                        easing: 'ease-out'
                    });
                    node.removeClass('highlighted pulsing');
                }
            });
            
            highlightedEdges.forEach(id => {
                const edge = cy.getElementById(id);
                if (edge.length) {
                    edge.animate({
                        style: {
                            'line-color': null,
                            'target-arrow-color': null,
                            'width': 2,
                            'opacity': 0.6
                        }
                    }, {
                        duration: 400,
                        easing: 'ease-out'
                    });
                    edge.removeClass('highlighted flowing');
                }
            });
            
            highlightedNodes.clear();
            highlightedEdges.clear();
            
            // Animate new highlights with beautiful effects
            nodeIds.forEach((id, index) => {
                const node = cy.getElementById(id);
                if (node.length) {
                    // Stagger animation for multiple nodes
                    const timeout = setTimeout(() => {
                        node.addClass('highlighted');
                        node.animate({
                            style: {
                                'background-color': '#1a73e8',
                                'border-color': '#1557b0',
                                'border-width': 5,
                                'width': '90px',
                                'height': '90px'
                            }
                        }, {
                            duration: 600,
                            easing: 'ease-out'
                        });
                        
                        // Add pulsing effect
                        setTimeout(() => {
                            node.addClass('pulsing');
                            // Remove pulsing after animation
                            setTimeout(() => node.removeClass('pulsing'), 2000);
                        }, 600);
                    }, index * 100);
                    animationTimeouts.push(timeout);
                    highlightedNodes.add(id);
                }
            });
            
            edgeIds.forEach((id, index) => {
                const edge = cy.getElementById(id);
                if (edge.length) {
                    const timeout = setTimeout(() => {
                        edge.addClass('highlighted');
                        edge.animate({
                            style: {
                                'line-color': '#1a73e8',
                                'target-arrow-color': '#1a73e8',
                                'width': 6,
                                'opacity': 1
                            }
                        }, {
                            duration: 600,
                            easing: 'ease-out'
                        });
                        
                        // Add flowing effect
                        setTimeout(() => {
                            edge.addClass('flowing');
                            setTimeout(() => edge.removeClass('flowing'), 2000);
                        }, 600);
                    }, (nodeIds.length * 100) + (index * 150));
                    animationTimeouts.push(timeout);
                    highlightedEdges.add(id);
                }
            });
            
            // Pulse lab items
            if (nodeIds.length > 0 && pipelineData) {
                const markerNodeIds = pipelineData.case_card?.abnormal_marker_node_ids || [];
                nodeIds.forEach((nodeId, idx) => {
                    if (markerNodeIds.includes(nodeId)) {
                        const markerNode = pipelineData.evidence_bundle.subgraph.nodes.find(n => n.id === nodeId);
                        if (markerNode) {
                            const labItem = document.querySelector(`[data-marker="${markerNode.label}"]`);
                            if (labItem) {
                                setTimeout(() => {
                                    labItem.classList.add('pulse');
                                    setTimeout(() => labItem.classList.remove('pulse'), 2000);
                                }, idx * 100);
                            }
                        }
                    }
                });
            }
        }

        function handleGuardrailFail(event) {
            const payload = event.payload || {};
            const failedRules = payload.failed_rules || [];
            
            const trustMoments = document.getElementById('trust-moments');
            const failCard = document.createElement('div');
            failCard.className = 'trust-moment guardrail-fail';
            
            let rulesHtml = '';
            if (failedRules.length > 0) {
                rulesHtml = failedRules.map(rule => {
                    const ruleId = rule.id || rule.rule_id || 'Unknown';
                    const message = rule.message || 'Guardrail check failed';
                    return `
                        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 6px;">
                            <div class="rule-id">Rule: ${ruleId}</div>
                            <div class="message">${message}</div>
                        </div>
                    `;
                }).join('');
            } else {
                rulesHtml = '<div class="message">Guardrail check failed</div>';
            }
            
            failCard.innerHTML = `
                <div class="trust-pill trust-pill-danger">Safety Intercept</div>
                <h4>Unsafe recommendation blocked</h4>
                <div style="font-size: 12px; color: #6a1b1a; margin-bottom: 10px;">
                    ${failedRules.length} guardrail rule${failedRules.length === 1 ? '' : 's'} triggered. The output is being patched automatically.
                </div>
                ${rulesHtml}
            `;
            trustMoments.appendChild(failCard);
            
            setTimeout(() => {
                failCard.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => failCard.remove(), 400);
            }, 10000);
        }

        function handleGuardrailPatch(event) {
            const payload = event.payload || {};
            const before = payload.before;
            const after = payload.after;
            
            if (!before || !after) return;
            
            const trustMoments = document.getElementById('trust-moments');
            const patchCard = document.createElement('div');
            patchCard.className = 'trust-moment patch-diff';
            
            // Get guardrail explanations from pipeline data if available
            const guardrailReport = pipelineData?.guardrail_report;
            const explanations = guardrailReport?.explanations || [];
            
            // Create human-readable explanation
            let explanationHtml = '';
            if (explanations.length > 0) {
                explanations.forEach(expl => {
                    explanationHtml += `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px; border-left: 3px solid #FF9800;">
                            <div style="font-weight: 600; color: #e65100; margin-bottom: 6px;">Safety Check: ${expl.rule_id || 'Guardrail'}</div>
                            <div style="font-size: 13px; line-height: 1.5; color: #424242; margin-bottom: 8px;">${expl.explanation || 'An unsafe recommendation was automatically removed.'}</div>
                            ${expl.risk_level ? `<div style="font-size: 11px; color: #666; margin-bottom: 6px;"><strong>Risk Level:</strong> ${expl.risk_level}</div>` : ''}
                            ${expl.alternative_actions && expl.alternative_actions.length > 0 ? `
                                <div style="margin-top: 8px;">
                                    <div style="font-size: 11px; font-weight: 600; color: #666; margin-bottom: 4px;">Safe Alternatives:</div>
                                    <ul style="margin: 0; padding-left: 20px; font-size: 11px; color: #424242;">
                                        ${expl.alternative_actions.map(alt => `<li>${typeof alt === 'string' ? alt : alt.action || alt}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            } else {
                // Fallback: create explanation from diff
                const removedActions = before.patient_actions?.filter(b => 
                    !after.patient_actions?.some(a => JSON.stringify(a) === JSON.stringify(b))
                ) || [];
                
                if (removedActions.length > 0) {
                    const action = removedActions[0];
                    explanationHtml = `
                        <div style="margin-bottom: 12px; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 6px; border-left: 3px solid #FF9800;">
                            <div style="font-weight: 600; color: #e65100; margin-bottom: 6px;">Safety Check: Unsafe Action Removed</div>
                            <div style="font-size: 13px; line-height: 1.5; color: #424242; margin-bottom: 8px;">
                                The system detected and automatically removed an unsafe recommendation: 
                                <strong>"${action.task || 'Unsafe action'}"</strong>
                            </div>
                            <div style="font-size: 11px; color: #666;">This action was blocked by safety guardrails to prevent potential harm to the patient.</div>
                        </div>
                    `;
                }
            }
            
            const diffHtml = createDiffHtml(before, after);
            
            patchCard.innerHTML = `
                <div class="trust-pill trust-pill-warn">Safety Patch</div>
                <h4>Unsafe content removed before final output</h4>
                ${explanationHtml}
                <div style="margin-top: 12px; font-size: 11px; color: #666; font-style: italic;">
                    The system automatically removed unsafe recommendations. See details below.
                </div>
                ${diffHtml}
            `;
            trustMoments.appendChild(patchCard);
            
            setTimeout(() => {
                patchCard.style.animation = 'slideInRight 0.4s ease-out reverse';
                setTimeout(() => patchCard.remove(), 400);
            }, 20000); // Keep visible longer for important safety info
        }

        function createDiffHtml(before, after) {
            // Handle patient_actions array specifically
            if (before.patient_actions && after.patient_actions) {
                const removed = before.patient_actions.filter(b => 
                    !after.patient_actions.some(a => JSON.stringify(a) === JSON.stringify(b))
                );
                const added = after.patient_actions.filter(a => 
                    !before.patient_actions.some(b => JSON.stringify(b) === JSON.stringify(a))
                );
                
                let html = '';
                if (removed.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Removed (Unsafe Actions):</h5>
                            ${removed.map(item => `
                                <div class="diff-before" style="margin-bottom: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">- ${item.task || 'Action'}</div>
                                    ${item.why ? `<div style="font-size: 10px; opacity: 0.8;">Reason: ${item.why}</div>` : ''}
                                    ${item.bucket ? `<div style="font-size: 10px; opacity: 0.8;">Category: ${item.bucket}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                if (added.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Added (Safe Alternatives):</h5>
                            ${added.map(item => `
                                <div class="diff-after" style="margin-bottom: 8px;">
                                    <div style="font-weight: 600; margin-bottom: 4px;">+ ${item.task || 'Action'}</div>
                                    ${item.why ? `<div style="font-size: 10px; opacity: 0.8;">Reason: ${item.why}</div>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                return html || '<div class="diff-section" style="font-size: 11px; color: #666;">No changes to patient actions</div>';
            }
            
            // Generic array handling
            if (Array.isArray(before) && Array.isArray(after)) {
                const removed = before.filter(b => !after.some(a => JSON.stringify(a) === JSON.stringify(b)));
                const added = after.filter(a => !before.some(b => JSON.stringify(b) === JSON.stringify(a)));
                
                let html = '';
                if (removed.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Removed:</h5>
                            ${removed.map(item => `
                                <div class="diff-before">- ${JSON.stringify(item, null, 2)}</div>
                            `).join('')}
                        </div>
                    `;
                }
                if (added.length > 0) {
                    html += `
                        <div class="diff-section">
                            <h5>Added:</h5>
                            ${added.map(item => `
                                <div class="diff-after">+ ${JSON.stringify(item, null, 2)}</div>
                            `).join('')}
                        </div>
                    `;
                }
                return html || '<div class="diff-section">No visible changes</div>';
            }
            
            return `
                <div class="diff-section">
                    <h5>Before:</h5>
                    <div class="diff-before">${JSON.stringify(before, null, 2)}</div>
                </div>
                <div class="diff-section">
                    <h5>After:</h5>
                    <div class="diff-after">${JSON.stringify(after, null, 2)}</div>
                </div>
            `;
        }

        function handleHypothesisReady(event) {
            const payload = event.payload || {};
            const edgeIds = payload.edge_ids || [];
            
            if (edgeIds.length > 0 && cy) {
                edgeIds.forEach((edgeId, idx) => {
                    const edge = cy.getElementById(edgeId);
                    if (edge.length) {
                        setTimeout(() => {
                            edge.animate({
                                style: {
                                    'line-color': '#FF9800',
                                    'target-arrow-color': '#FF9800',
                                    'width': 6,
                                    'opacity': 1
                                }
                            }, {
                                duration: 500,
                                easing: 'ease-out'
                            });
                            setTimeout(() => {
                                edge.animate({
                                    style: {
                                        'line-color': null,
                                        'target-arrow-color': null,
                                        'width': null,
                                        'opacity': null
                                    }
                                }, {
                                    duration: 500,
                                    easing: 'ease-in'
                                });
                            }, 3000);
                        }, idx * 200);
                    }
                });
            }
        }

        function handleCandidates(event) {
            console.log('Candidates:', event.payload);
        }

        function handleEvidenceApplied(event) {
            const payload = event.payload || {};
            const edgeId = payload.highlight_edge_id || payload.edge_id;
            
            if (edgeId && cy) {
                const edge = cy.getElementById(edgeId);
                if (edge.length) {
                    edge.animate({
                        style: {
                            'line-color': '#2196F3',
                            'target-arrow-color': '#2196F3',
                            'width': 5,
                            'opacity': 1
                        }
                    }, {
                        duration: 400,
                        easing: 'ease-out'
                    });
                    setTimeout(() => {
                        edge.animate({
                            style: {
                                'line-color': null,
                                'target-arrow-color': null,
                                'width': null,
                                'opacity': null
                            }
                        }, {
                            duration: 400,
                            easing: 'ease-in'
                        });
                    }, 2500);
                }
            }
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.tab-button[onclick="showTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function toggleReasoningTrace(event) {
            // Prevent event bubbling if called from checkbox click
            if (event) {
                event.stopPropagation();
            }
            
            const checkbox = document.getElementById('trace-checkbox');
            const content = document.getElementById('reasoning-trace-content');
            
            // Toggle checkbox state
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                content.classList.add('active');
                renderReasoningTrace();
            } else {
                content.classList.remove('active');
            }
        }

        // Handle checkbox click separately
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('trace-checkbox');
            if (checkbox) {
                checkbox.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleReasoningTrace(e);
                });
            }
        });

        function renderReasoningTrace() {
            if (!pipelineData) {
                const traceContent = document.getElementById('reasoning-trace-content');
                if (traceContent) {
                    traceContent.innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px;">No case data loaded. Please load a case first.</div>';
                }
                return;
            }
            
            const evidenceBundle = pipelineData.evidence_bundle;
            const traceContent = document.getElementById('reasoning-trace-content');
            const events = pipelineData.events || [];
            
            if (!evidenceBundle) {
                if (traceContent) {
                    traceContent.innerHTML = '<div style="padding: 12px; color: #6c757d; font-size: 12px;">No evidence bundle available.</div>';
                }
                return;
            }
            
            let html = '';
            
            // Show model usage if available
            const modelUsage = pipelineData.model_usage;
            if (modelUsage && modelUsage.model_mode) {
                html += '<div style="margin-bottom: 14px; padding: 10px 12px; background: var(--c-primary-light); border-radius: var(--r-md); border-left: 3px solid var(--c-primary);">';
                html += '<h5 style="font-size: 11px; font-weight: 600; color: var(--c-primary-dark); margin-bottom: 4px; text-transform: uppercase; letter-spacing: .3px;">Model Usage</h5>';
                html += `<div style="font-size: 12px; color: var(--c-text); font-family: var(--mono);">Model calls: ${modelUsage.model_calls || 0} &middot; Agent decisions: ${modelUsage.agent_decisions || 0}</div>`;
                html += '</div>';
            }
            
            // Show model reasoning from events
            const modelEvents = events.filter(e => e && e.type === 'MODEL_CALLED' && e.payload && e.payload.status === 'success');
            if (modelEvents.length > 0) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Model Reasoning</h5>';
                modelEvents.forEach((event, idx) => {
                    const payload = event.payload || {};
                    const agentType = (payload.agent_type != null) ? String(payload.agent_type) : 'unknown';
                    const responseTime = payload.response_time_ms != null ? `${Math.round(payload.response_time_ms)}ms` : 'N/A';
                    const cached = payload.cached ? ' (cached)' : '';
                    const agentDisplay = agentType.replace(/_/g, ' ').replace(/\b\w/g, ch => (ch && typeof ch === 'string') ? ch.toUpperCase() : ch);
                    html += `
                        <div class="evidence-item" style="border-left-color: var(--c-primary);">
                            <strong>${agentDisplay}</strong>
                            <div class="edge-id">Response: ${responseTime}${cached}</div>
                        </div>
                    `;
                });
            }
            
            // Show agent decisions
            const agentDecisions = events.filter(e => e && e.type === 'AGENT_DECISION');
            if (agentDecisions.length > 0) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Agent Decisions</h5>';
                agentDecisions.forEach((event, idx) => {
                    const payload = event.payload || {};
                    const agentType = (payload.agent_type != null) ? String(payload.agent_type) : 'unknown';
                    const decision = (payload.decision != null) ? String(payload.decision) : 'unknown';
                    const rationale = (payload.rationale != null) ? String(payload.rationale) : '';
                    const decisionColor = decision === 'use_model' ? 'var(--c-primary)' : 'var(--c-text-ter)';
                    const agentDisplay = agentType.replace(/_/g, ' ').replace(/\b\w/g, ch => (ch && typeof ch === 'string') ? ch.toUpperCase() : ch);
                    html += `
                        <div class="evidence-item" style="border-left-color: ${decisionColor};">
                            <strong>${agentDisplay}</strong>: 
                            <span style="color: ${decisionColor}; font-weight: 600;">${decision === 'use_model' ? 'Model' : 'Rules'}</span>
                            ${rationale ? `<div class="edge-id">${rationale}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // Show candidate scores if available
            if (evidenceBundle.candidate_scores && Object.keys(evidenceBundle.candidate_scores).length > 0) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Pattern Scores</h5>';
                const scores = Object.entries(evidenceBundle.candidate_scores)
                    .sort((a, b) => b[1] - a[1])
                    .map(([pattern, score]) => {
                        const percentage = Math.round(score * 100);
                        return `
                            <div class="evidence-item" style="border-left-color: var(--c-primary);">
                                <strong>${pattern}</strong>: <span style="font-family: var(--mono);">${percentage}%</span>
                            </div>
                        `;
                    }).join('');
                html += scores;
            }
            
            // Show top discriminators
            if (evidenceBundle.top_discriminators && evidenceBundle.top_discriminators.length > 0) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Key Evidence</h5>';
                evidenceBundle.top_discriminators.forEach(item => {
                    const relation = item.relation || 'SUPPORTS';
                    const borderColor = relation === 'SUPPORTS' ? 'var(--c-success)' : 'var(--c-error)';
                    html += `
                        <div class="evidence-item" style="border-left-color: ${borderColor};">
                            <strong>${item.marker}</strong> (${item.marker_status === 'REFERENCE_UNKNOWN' ? 'Ref unknown' : item.marker_status}) 
                            <span style="color: ${borderColor}; font-weight: 600;">${relation}</span> 
                            ${item.pattern_id}
                            <div class="edge-id">Edge: ${item.edge_id} &middot; Weight: ${item.weight?.toFixed(2) || 'N/A'}</div>
                        </div>
                    `;
                });
            }
            
            if (evidenceBundle.supports && evidenceBundle.supports.length > 0) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Supporting Evidence</h5>';
                evidenceBundle.supports.forEach(item => {
                    html += `
                        <div class="evidence-item">
                            <strong>${item.marker}</strong> (${item.marker_status === 'REFERENCE_UNKNOWN' ? 'Reference unknown' : item.marker_status}) → ${item.pattern_id}
                            <div class="edge-id">Edge: ${item.edge_id}</div>
                        </div>
                    `;
                });
            }
            
            if (evidenceBundle.contradictions && evidenceBundle.contradictions.length > 0) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Contradicting Evidence</h5>';
                evidenceBundle.contradictions.forEach(item => {
                    html += `
                        <div class="evidence-item" style="border-left-color: var(--c-error);">
                            <strong>${item.marker}</strong> (${item.marker_status === 'REFERENCE_UNKNOWN' ? 'Reference unknown' : item.marker_status}) → ${item.pattern_id}
                            <div class="edge-id">Edge: ${item.edge_id}</div>
                        </div>
                    `;
                });
            }
            
            // Show raw model output if available
            if (pipelineData.reasoner_output && pipelineData.reasoner_output.raw_model_output) {
                html += '<h5 style="margin-top: 14px; font-size: 11px; font-weight: 600; color: var(--c-text-sec); text-transform: uppercase; letter-spacing: .3px;">Raw Model Output</h5>';
                html += `<div class="evidence-item" style="border-left-color: var(--c-text-ter); font-family: var(--mono); font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${pipelineData.reasoner_output.raw_model_output.substring(0, 500)}${pipelineData.reasoner_output.raw_model_output.length > 500 ? '...' : ''}</div>`;
            }
            
            if (!html) {
                html = '<div style="padding: 12px; color: #6c757d; font-size: 12px;">No reasoning trace data available for this case.</div>';
            }
            
            if (traceContent) {
                traceContent.innerHTML = html;
            }
        }

        function toggleLegend() {
            const legend = document.getElementById('graph-legend');
            const content = document.getElementById('legend-content');
            const toggle = document.getElementById('legend-toggle');
            
            if (legend.classList.contains('collapsed')) {
                legend.classList.remove('collapsed');
                content.style.display = 'block';
                toggle.textContent = '−';
            } else {
                legend.classList.add('collapsed');
                content.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function toggleAgentActivity() {
            const panel = document.getElementById('agent-activity');
            const content = document.getElementById('agent-content');
            const toggle = document.getElementById('agent-toggle');
            
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                toggle.textContent = '−';
                renderAgentActivity();
            } else {
                panel.style.display = 'none';
                toggle.textContent = '+';
            }
        }

        function renderAgentActivity() {
            if (!pipelineData || !pipelineData.events) return;
            
            const events = pipelineData.events;
            const agentDecisions = events.filter(e => e.type === 'AGENT_DECISION');
            const modelCalls = events.filter(e => e.type === 'MODEL_CALLED' && e.payload.status === 'success');
            
            const content = document.getElementById('agent-content');
            let html = '';
            
            if (agentDecisions.length === 0 && modelCalls.length === 0) {
                html = '<div style="padding: 12px; color: #6c757d; font-size: 12px; text-align: center;">No agent activity (lite mode)</div>';
            } else {
                // Group decisions by agent type
                const decisionsByAgent = {};
                agentDecisions.forEach(decision => {
                    const payload = decision && decision.payload;
                    const agentType = (payload && payload.agent_type != null) ? String(payload.agent_type) : 'unknown';
                    if (!decisionsByAgent[agentType]) {
                        decisionsByAgent[agentType] = [];
                    }
                    decisionsByAgent[agentType].push(decision);
                });
                
                // Show each agent's activity
                Object.keys(decisionsByAgent).forEach(agentTypeKey => {
                    const decisions = decisionsByAgent[agentTypeKey];
                    const lastDecision = decisions[decisions.length - 1];
                    const lastPayload = lastDecision && lastDecision.payload;
                    const decision = lastPayload && lastPayload.decision != null ? String(lastPayload.decision) : '';
                    const rationale = (lastPayload && lastPayload.rationale != null) ? String(lastPayload.rationale) : '';
                    const modelCall = modelCalls.find(m => m.payload && (m.payload.agent_type == null ? agentTypeKey === 'unknown' : String(m.payload.agent_type) === agentTypeKey));
                    
                    const isModelUsed = decision === 'use_model' && modelCall;
                    const responseTime = modelCall && modelCall.payload ? `${Math.round(modelCall.payload.response_time_ms || 0)}ms` : '';
                    const cached = modelCall && modelCall.payload && modelCall.payload.cached ? ' (cached)' : '';
                    const agentTypeDisplay = (typeof agentTypeKey === 'string') ? agentTypeKey.replace(/_/g, ' ').replace(/\b\w/g, l => (l && typeof l === 'string') ? l.toUpperCase() : l) : 'unknown';
                    
                    html += `
                        <div class="agent-call-item ${isModelUsed ? '' : 'rule-based'}">
                            <h6>
                                <span class="agent-type">${agentTypeDisplay}</span>
                            </h6>
                            <div style="font-size: 11px; color: ${isModelUsed ? 'var(--c-primary-dark)' : 'var(--c-text-sec)'}; font-weight: 600;">
                                ${isModelUsed ? 'Using Model' : 'Using Rules'}
                            </div>
                            ${responseTime ? `<div class="agent-time">Response: ${responseTime}${cached}</div>` : ''}
                            ${rationale ? `<div class="agent-rationale">${rationale}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            content.innerHTML = html;
            
            // Show panel if there's activity
            if (agentDecisions.length > 0 || modelCalls.length > 0) {
                document.getElementById('agent-activity').style.display = 'block';
            }
        }

        /**
         * Compute conclusion highlight IDs from pipelineData: supporting edges and recommended test nodes/edges.
         * Returns { supportingEdgeIds: Set, recommendedNodeIds: Set, recommendedEdgeIds: Set }.
         */
        function getConclusionHighlightIds(data) {
            const supportingEdgeIds = new Set();
            const recommendedNodeIds = new Set();
            const recommendedEdgeIds = new Set();
            if (!data || !data.evidence_bundle) return { supportingEdgeIds, recommendedNodeIds, recommendedEdgeIds };

            const bundle = data.evidence_bundle;
            const subgraph = bundle.subgraph || { nodes: [], edges: [] };
            const reasoner = data.reasoner_output || { hypotheses: [] };

            // Supporting edge IDs: from evidence_bundle.supports and hypotheses[].evidence[].edge_id
            (bundle.supports || []).forEach(item => {
                if (item.edge_id) supportingEdgeIds.add(item.edge_id);
                (item.edge_ids || []).forEach(id => supportingEdgeIds.add(id));
            });
            (reasoner.hypotheses || []).forEach(h => {
                (h.evidence || []).forEach(ev => {
                    if (ev.edge_id) supportingEdgeIds.add(ev.edge_id);
                });
            });

            // Recommended test node IDs: from hypotheses[].next_tests (string or { test_id, label })
            const testNodes = (subgraph.nodes || []).filter(n => n.type === 'Test');
            (reasoner.hypotheses || []).forEach(h => {
                (h.next_tests || []).forEach(t => {
                    if (t == null) return;
                    let id = null;
                    if (typeof t === 'object' && t !== null && t.test_id) id = t.test_id;
                    else if (typeof t === 'string' && t.trim()) {
                        const lower = safeLower(t);
                        const match = testNodes.find(n =>
                            n.id === t || n.id === 't_' + lower.replace(/\s+/g, '_') ||
                            (typeof n.label === 'string' && safeLower(n.label).includes(lower))
                        );
                        id = match ? match.id : null;
                    }
                    if (id) recommendedNodeIds.add(id);
                });
            });

            // Recommended edge IDs: RECOMMENDS_TEST edges whose target (or source) is a recommended test node
            (subgraph.edges || []).forEach(edge => {
                if (edge.relation === 'RECOMMENDS_TEST' &&
                    (recommendedNodeIds.has(edge.to) || recommendedNodeIds.has(edge.from))) {
                    recommendedEdgeIds.add(edge.id);
                }
            });

            return { supportingEdgeIds, recommendedNodeIds, recommendedEdgeIds };
        }

        // Keep final state clear after animation completes; apply conclusion highlights (supporting edges, recommended tests)
        function finalizeGraphState() {
            if (!cy) return;
            
            // Remove step animation classes and previous conclusion classes
            cy.nodes().removeClass('highlighted pulsing conclusion-support conclusion-recommended');
            cy.edges().removeClass('highlighted flowing conclusion-support conclusion-recommended');
            
            // Reset nodes/edges to default visibility
            cy.nodes().forEach(node => {
                const type = node.data('type');
                if (type) {
                    node.style({
                        'opacity': 1,
                        'background-opacity': 0.95
                    });
                }
            });
            cy.edges().forEach(edge => {
                const relation = edge.data('relation');
                if (relation) {
                    edge.style({
                        'opacity': 0.7
                    });
                }
            });

            // Apply conclusion highlights from pipelineData
            const ids = getConclusionHighlightIds(pipelineData);
            ids.supportingEdgeIds.forEach(edgeId => {
                const edge = cy.getElementById(edgeId);
                if (edge.length) edge.addClass('conclusion-support');
            });
            ids.recommendedNodeIds.forEach(nodeId => {
                const node = cy.getElementById(nodeId);
                if (node.length) node.addClass('conclusion-recommended');
            });
            ids.recommendedEdgeIds.forEach(edgeId => {
                const edge = cy.getElementById(edgeId);
                if (edge.length) edge.addClass('conclusion-recommended');
            });
        }

        window.onload = init;
    </script>
</body>
</html>
